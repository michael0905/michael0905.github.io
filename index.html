<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Yiyuan Liu&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Yiyuan Liu's Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Yiyuan Liu's Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Yiyuan Liu's Blog">
  
    <link rel="alternate" href="/atom.xml" title="Yiyuan Liu&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Yiyuan Liu&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="Flux RSS"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Rechercher"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-python文本相似度计算" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/28/python文本相似度计算/" class="article-date">
  <time datetime="2017-04-28T13:08:31.000Z" itemprop="datePublished">2017-04-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/自然语言处理/">自然语言处理</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/28/python文本相似度计算/">python文本相似度计算</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ol>
<li>分词、去停用词</li>
<li>词袋模型向量化文本</li>
<li>TF-IDF模型向量化文本</li>
<li>LSI模型向量化文本</li>
<li>计算相似度</li>
</ol>
<h2 id="理论知识"><a href="#理论知识" class="headerlink" title="理论知识"></a>理论知识</h2><p>两篇中文文本，如何计算相似度？相似度是数学上的概念，自然语言肯定无法完成，所有要把文本转化为向量。两个向量计算相似度就很简单了，欧式距离、余弦相似度等等各种方法，只需要中学水平的数学知识。</p>
<p>那么如何将文本表示成向量呢？</p>
<ul>
<li><p>词袋模型<br>最简单的表示方法是词袋模型。把一篇文本想象成一个个词构成的，所有词放入一个袋子里，没有先后顺序、没有语义。<br>例如：</p>
<pre><code>John likes to watch movies. Mary likes too.
John also likes to watch football games.
</code></pre><p>这两个句子，可以构建出一个词典，key为上文出现过的词，value为这个词的索引序号<br>{“John”: 1, “likes”: 2,”to”: 3, “watch”: 4, “movies”: 5,”also”: 6, “football”: 7, “games”: 8,”Mary”: 9, “too”: 10}<br>那么，上面两个句子用词袋模型表示成向量就是：<br>[1, 2, 1, 1, 1, 0, 0, 0, 1, 1]<br>[1, 1,1, 1, 0, 1, 1, 1, 0, 0]<br>相对于英文，中文更复杂一些，涉及到分词。准确地分词是所有中文文本分析的基础，本文使用结巴分词，完全开源而且分词准确率相对有保障。</p>
</li>
<li><p>TF-IDF模型<br>词袋模型简单易懂，但是存在问题。中文文本里最常见的词是“的”、“是”、“有”这样的没有实际含义的词。一篇关于足球的中文文本，“的”出现的数量肯定多于“足球”。所以，要对文本中出现的词赋予权重。<br>一个词的权重由TF * IDF 表示，其中TF表示词频，即一个词在这篇文本中出现的频率；IDF表示逆文档频率，即一个词在所有文本中出现的频率倒数。因此，一个词在某文本中出现的越多，在其他文本中出现的越少，则这个词能很好地反映这篇文本的内容，权重就越大。<br>回过头看词袋模型，只考虑了文本的词频，而TF-IDF模型则包含了词的权重，更加准确。文本向量与词袋模型中的维数相同，只是每个词的对应分量值换成了该词的TF-IDF值。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1972331-72b27e31abeeb5cd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/310" alt="TF"></p>
</li>
</ul>
<p>  <img src="http://upload-images.jianshu.io/upload_images/1972331-b7da2527af21fbd0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/310" alt="IDF"></p>
<ul>
<li>LSI模型<br>TF-IDF模型足够胜任普通的文本分析任务，用TF-IDF模型计算文本相似度已经比较靠谱了，但是细究的话还存在不足之处。实际的中文文本，用TF-IDF表示的向量维数可能是几百、几千，不易分析计算。此外，一些文本的主题或者说中心思想，并不能很好地通过文本中的词来表示，能真正概括这篇文本内容的词可能没有直接出现在文本中。<br>因此，这里引入了Latent Semantic Indexing（LSI）从文本潜在的主题来进行分析。LSI是概率主题模型的一种，另一种常见的是LDA，核心思想是：每篇文本中有多个概率分布不同的主题；每个主题中都包含所有已知词，但是这些词在不同主题中的概率分布不同。LSI通过奇异值分解的方法计算出文本中各个主题的概率分布，严格的数学证明需要看相关论文。假设有5个主题，那么通过LSI模型，文本向量就可以降到5维，每个分量表示对应主题的权重。</li>
</ul>
<h2 id="python实现"><a href="#python实现" class="headerlink" title="python实现"></a>python实现</h2><p>分词上使用了<a href="https://github.com/fxsjy/jieba" target="_blank" rel="external">结巴分词</a>，词袋模型、TF-IDF模型、LSI模型的实现使用了<a href="https://github.com/RaRe-Technologies/gensim" target="_blank" rel="external">gensim</a>库。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> jieba.posseg <span class="keyword">as</span> pseg</div><div class="line"><span class="keyword">import</span> codecs</div><div class="line"><span class="keyword">from</span> gensim <span class="keyword">import</span> corpora, models, similarities</div></pre></td></tr></table></figure>
<h4 id="构建停用词表"><a href="#构建停用词表" class="headerlink" title="构建停用词表"></a>构建停用词表</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">stop_words = <span class="string">'/Users/yiiyuanliu/Desktop/nlp/demo/stop_words.txt'</span></div><div class="line">stopwords = codecs.open(stop_words,<span class="string">'r'</span>,encoding=<span class="string">'utf8'</span>).readlines()</div><div class="line">stopwords = [ w.strip() <span class="keyword">for</span> w <span class="keyword">in</span> stopwords ]</div></pre></td></tr></table></figure>
<h4 id="结巴分词后的停用词性-标点符号、连词、助词、副词、介词、时语素、‘的’、数词、方位词、代词"><a href="#结巴分词后的停用词性-标点符号、连词、助词、副词、介词、时语素、‘的’、数词、方位词、代词" class="headerlink" title="结巴分词后的停用词性 [标点符号、连词、助词、副词、介词、时语素、‘的’、数词、方位词、代词]"></a>结巴分词后的停用词性 [标点符号、连词、助词、副词、介词、时语素、‘的’、数词、方位词、代词]</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">stop_flag = [<span class="string">'x'</span>, <span class="string">'c'</span>, <span class="string">'u'</span>,<span class="string">'d'</span>, <span class="string">'p'</span>, <span class="string">'t'</span>, <span class="string">'uj'</span>, <span class="string">'m'</span>, <span class="string">'f'</span>, <span class="string">'r'</span>]</div></pre></td></tr></table></figure>
<h4 id="对一篇文章分词、去停用词"><a href="#对一篇文章分词、去停用词" class="headerlink" title="对一篇文章分词、去停用词"></a>对一篇文章分词、去停用词</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">tokenization</span><span class="params">(filename)</span>:</span></div><div class="line">    result = []</div><div class="line">    <span class="keyword">with</span> open(filename, <span class="string">'r'</span>) <span class="keyword">as</span> f:</div><div class="line">        text = f.read()</div><div class="line">        words = pseg.cut(text)</div><div class="line">    <span class="keyword">for</span> word, flag <span class="keyword">in</span> words:</div><div class="line">        <span class="keyword">if</span> flag <span class="keyword">not</span> <span class="keyword">in</span> stop_flag <span class="keyword">and</span> word <span class="keyword">not</span> <span class="keyword">in</span> stopwords:</div><div class="line">            result.append(word)</div><div class="line">    <span class="keyword">return</span> result</div></pre></td></tr></table></figure>
<h4 id="选取三篇文章，前两篇是高血压主题的，第三篇是iOS主题的。"><a href="#选取三篇文章，前两篇是高血压主题的，第三篇是iOS主题的。" class="headerlink" title="选取三篇文章，前两篇是高血压主题的，第三篇是iOS主题的。"></a>选取三篇文章，前两篇是高血压主题的，第三篇是iOS主题的。</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">filenames = [<span class="string">'/Users/yiiyuanliu/Desktop/nlp/demo/articles/13 件小事帮您稳血压.txt'</span>, </div><div class="line">             <span class="string">'/Users/yiiyuanliu/Desktop/nlp/demo/articles/高血压患者宜喝低脂奶.txt'</span>,</div><div class="line">             <span class="string">'/Users/yiiyuanliu/Desktop/nlp/demo/articles/ios.txt'</span></div><div class="line">            ]</div><div class="line">corpus = []</div><div class="line"><span class="keyword">for</span> each <span class="keyword">in</span> filenames:</div><div class="line">    corpus.append(tokenization(each))</div><div class="line"><span class="keyword">print</span> len(corpus)</div></pre></td></tr></table></figure>
<pre><code>Building prefix dict from the default dictionary ...
Loading model from cache /var/folders/1q/5404x10d3k76q2wqys68pzkh0000gn/T/jieba.cache
Loading model cost 0.349 seconds.
Prefix dict has been built succesfully.


3
</code></pre><h4 id="建立词袋模型"><a href="#建立词袋模型" class="headerlink" title="建立词袋模型"></a>建立词袋模型</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">dictionary = corpora.Dictionary(corpus)</div><div class="line"><span class="keyword">print</span> dictionary</div></pre></td></tr></table></figure>
<pre><code>Dictionary(431 unique tokens: [u&apos;\u627e\u51fa&apos;, u&apos;\u804c\u4f4d&apos;, u&apos;\u6253\u9f3e&apos;, u&apos;\u4eba\u7fa4&apos;, u&apos;\u996e\u54c1&apos;]...)
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">doc_vectors = [dictionary.doc2bow(text) <span class="keyword">for</span> text <span class="keyword">in</span> corpus]</div><div class="line"><span class="keyword">print</span> len(doc_vectors)</div><div class="line"><span class="keyword">print</span> doc_vectors</div></pre></td></tr></table></figure>
<pre><code>3
[[(0, 1), (1, 3), (2, 2), (3, 1), (4, 3), (5, 3), (6, 3), (7, 1), (8, 1), (9, 1), (10, 1), (11, 3), (12, 1), (13, 2), (14, 3), (15, 3), (16, 1), (17, 2), (18, 1), (19, 1), (20, 1), (21, 2), (22, 1), (23, 1), (24, 1), (25, 1), (26, 1), (27, 3), (28, 1), (29, 1), (30, 1), (31, 1), (32, 1), (33, 1), (34, 1), (35, 1), (36, 1), (37, 1), (38, 1), (39, 1), (40, 2), (41, 1), (42, 2), (43, 1), (44, 2), (45, 1), (46, 4), (47, 1), (48, 2), (49, 1), (50, 2), (51, 1), (52, 1), (53, 1), (54, 1), (55, 1), (56, 1), (57, 1), (58, 1), (59, 1), (60, 1), (61, 1), (62, 1), (63, 1), (64, 1), (65, 3), (66, 1), (67, 1), (68, 1), (69, 2), (70, 2), (71, 5), (72, 1), (73, 2), (74, 3), (75, 1), (76, 1), (77, 1), (78, 2), (79, 1), (80, 1), (81, 1), (82, 1), (83, 2), (84, 3), (85, 1), (86, 2), (87, 1), (88, 3), (89, 1), (90, 1), (91, 1), (92, 2), (93, 1), (94, 1), (95, 2), (96, 2), (97, 1), (98, 3), (99, 1), (100, 1), (101, 1), (102, 2), (103, 1), (104, 1), (105, 1), (106, 1), (107, 1), (108, 2), (109, 1), (110, 1), (111, 1), (112, 1), (113, 1), (114, 1), (115, 1), (116, 1), (117, 1), (118, 1), (119, 2), (120, 1), (121, 1), (122, 1), (123, 1), (124, 1), (125, 1), (126, 1), (127, 1), (128, 5), (129, 5), (130, 1), (131, 1), (132, 2), (133, 1), (134, 1), (135, 1), (136, 1), (137, 1), (138, 6), (139, 1), (140, 1), (141, 1), (142, 4), (143, 1), (144, 2), (145, 1), (146, 1), (147, 1), (148, 2), (149, 1), (150, 1), (151, 5), (152, 1), (153, 1), (154, 1), (155, 1), (156, 1), (157, 1), (158, 1), (159, 1), (160, 1), (161, 2), (162, 15), (163, 3), (164, 1), (165, 1), (166, 2), (167, 1), (168, 6), (169, 1), (170, 1), (171, 1), (172, 3), (173, 1), (174, 1), (175, 2), (176, 1), (177, 1), (178, 2), (179, 2), (180, 1), (181, 6), (182, 1), (183, 1), (184, 1), (185, 2), (186, 1), (187, 1), (188, 1), (189, 1), (190, 1), (191, 1), (192, 1), (193, 1), (194, 1), (195, 1), (196, 1), (197, 1), (198, 1), (199, 1), (200, 1), (201, 5), (202, 1), (203, 2), (204, 2), (205, 1), (206, 1), (207, 1), (208, 1), (209, 2), (210, 1), (211, 1), (212, 1), (213, 1), (214, 1), (215, 1), (216, 1), (217, 1), (218, 1), (219, 3), (220, 1), (221, 1), (222, 4), (223, 1), (224, 1), (225, 1), (226, 1), (227, 1), (228, 1), (229, 1), (230, 1), (231, 2), (232, 12), (233, 1), (234, 1), (235, 1), (236, 2), (237, 1), (238, 1), (239, 1), (240, 1), (241, 1), (242, 1), (243, 1), (244, 1), (245, 1), (246, 1), (247, 4), (248, 2), (249, 1), (250, 1), (251, 1), (252, 1), (253, 2), (254, 1), (255, 1), (256, 1), (257, 6), (258, 1), (259, 2)], [(6, 1), (7, 1), (11, 1), (14, 1), (15, 2), (27, 1), (47, 2), (71, 1), (78, 1), (92, 2), (101, 1), (106, 1), (112, 4), (121, 1), (138, 6), (143, 1), (151, 2), (155, 1), (158, 1), (162, 4), (170, 2), (203, 1), (213, 1), (227, 1), (232, 7), (254, 2), (260, 1), (261, 1), (262, 1), (263, 1), (264, 1), (265, 1), (266, 1), (267, 2), (268, 1), (269, 1), (270, 1), (271, 1), (272, 1), (273, 1), (274, 1), (275, 1), (276, 2), (277, 3), (278, 1), (279, 1), (280, 1), (281, 1), (282, 1), (283, 1), (284, 1), (285, 1), (286, 2), (287, 1), (288, 3), (289, 1), (290, 1), (291, 1), (292, 2), (293, 2), (294, 1), (295, 1), (296, 1), (297, 3), (298, 1), (299, 1), (300, 1), (301, 1), (302, 1)], [(14, 5), (19, 1), (22, 1), (25, 1), (27, 3), (77, 3), (89, 1), (103, 2), (132, 1), (137, 2), (147, 1), (161, 1), (169, 5), (201, 2), (208, 2), (257, 1), (266, 1), (272, 1), (303, 2), (304, 2), (305, 1), (306, 6), (307, 1), (308, 2), (309, 2), (310, 1), (311, 2), (312, 1), (313, 1), (314, 10), (315, 1), (316, 1), (317, 3), (318, 1), (319, 1), (320, 1), (321, 3), (322, 2), (323, 3), (324, 2), (325, 14), (326, 1), (327, 1), (328, 3), (329, 1), (330, 1), (331, 2), (332, 6), (333, 2), (334, 3), (335, 1), (336, 1), (337, 1), (338, 1), (339, 1), (340, 4), (341, 1), (342, 1), (343, 1), (344, 3), (345, 1), (346, 1), (347, 1), (348, 1), (349, 1), (350, 1), (351, 2), (352, 4), (353, 2), (354, 1), (355, 1), (356, 1), (357, 3), (358, 1), (359, 14), (360, 1), (361, 1), (362, 1), (363, 1), (364, 2), (365, 1), (366, 1), (367, 1), (368, 4), (369, 1), (370, 1), (371, 1), (372, 1), (373, 1), (374, 1), (375, 1), (376, 2), (377, 1), (378, 1), (379, 1), (380, 1), (381, 2), (382, 1), (383, 4), (384, 1), (385, 2), (386, 1), (387, 1), (388, 2), (389, 1), (390, 1), (391, 1), (392, 2), (393, 1), (394, 1), (395, 2), (396, 1), (397, 1), (398, 2), (399, 1), (400, 1), (401, 2), (402, 1), (403, 3), (404, 2), (405, 1), (406, 1), (407, 2), (408, 1), (409, 2), (410, 1), (411, 2), (412, 2), (413, 1), (414, 1), (415, 1), (416, 1), (417, 1), (418, 1), (419, 5), (420, 1), (421, 1), (422, 1), (423, 3), (424, 1), (425, 1), (426, 1), (427, 1), (428, 1), (429, 1), (430, 6)]]
</code></pre><h4 id="建立TF-IDF模型"><a href="#建立TF-IDF模型" class="headerlink" title="建立TF-IDF模型"></a>建立TF-IDF模型</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tfidf = models.TfidfModel(doc_vectors)</div><div class="line">tfidf_vectors = tfidf[doc_vectors]</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">print</span> len(tfidf_vectors)</div><div class="line"><span class="keyword">print</span> len(tfidf_vectors[<span class="number">0</span>])</div></pre></td></tr></table></figure>
<pre><code>3
258
</code></pre><h4 id="构建一个query文本，是高血压主题的，利用词袋模型的字典将其映射到向量空间"><a href="#构建一个query文本，是高血压主题的，利用词袋模型的字典将其映射到向量空间" class="headerlink" title="构建一个query文本，是高血压主题的，利用词袋模型的字典将其映射到向量空间"></a>构建一个query文本，是高血压主题的，利用词袋模型的字典将其映射到向量空间</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">query = tokenization(<span class="string">'/Users/yiiyuanliu/Desktop/nlp/demo/articles/关于降压药的五个问题.txt'</span>)</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">query_bow = dictionary.doc2bow(query)</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">print</span> len(query_bow)</div><div class="line"><span class="keyword">print</span> query_bow</div></pre></td></tr></table></figure>
<pre><code>35
[(6, 1), (11, 1), (14, 1), (19, 1), (25, 1), (28, 1), (38, 2), (44, 3), (50, 4), (67, 1), (71, 1), (97, 1), (101, 3), (105, 2), (137, 1), (138, 4), (148, 6), (151, 2), (155, 1), (158, 3), (162, 4), (169, 1), (173, 2), (203, 1), (232, 12), (236, 1), (244, 9), (257, 1), (266, 1), (275, 2), (282, 1), (290, 2), (344, 1), (402, 1), (404, 3)]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">index = similarities.MatrixSimilarity(tfidf_vectors)</div></pre></td></tr></table></figure>
<h4 id="用TF-IDF模型计算相似度，相对于前两篇高血压主题的文本，iOS主题文本与query的相似度很低。可见TF-IDF模型是有效的，然而在语料较少的情况下，与同是高血压主题的文本相似度也不高。"><a href="#用TF-IDF模型计算相似度，相对于前两篇高血压主题的文本，iOS主题文本与query的相似度很低。可见TF-IDF模型是有效的，然而在语料较少的情况下，与同是高血压主题的文本相似度也不高。" class="headerlink" title="用TF-IDF模型计算相似度，相对于前两篇高血压主题的文本，iOS主题文本与query的相似度很低。可见TF-IDF模型是有效的，然而在语料较少的情况下，与同是高血压主题的文本相似度也不高。"></a>用TF-IDF模型计算相似度，相对于前两篇高血压主题的文本，iOS主题文本与query的相似度很低。可见TF-IDF模型是有效的，然而在语料较少的情况下，与同是高血压主题的文本相似度也不高。</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sims = index[query_bow]</div><div class="line"><span class="keyword">print</span> list(enumerate(sims))</div></pre></td></tr></table></figure>
<pre><code>[(0, 0.28532028), (1, 0.28572506), (2, 0.023022989)]
</code></pre><h4 id="构建LSI模型，设置主题数为2（理论上这两个主题应该分别为高血压和iOS）"><a href="#构建LSI模型，设置主题数为2（理论上这两个主题应该分别为高血压和iOS）" class="headerlink" title="构建LSI模型，设置主题数为2（理论上这两个主题应该分别为高血压和iOS）"></a>构建LSI模型，设置主题数为2（理论上这两个主题应该分别为高血压和iOS）</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lsi = models.LsiModel(tfidf_vectors, id2word=dictionary, num_topics=<span class="number">2</span>)</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lsi.print_topics(<span class="number">2</span>)</div></pre></td></tr></table></figure>
<pre><code>[(0,
  u&apos;0.286*&quot;\u9ad8\u8840\u538b&quot; + 0.241*&quot;\u8840\u538b&quot; + 0.204*&quot;\u60a3\u8005&quot; + 0.198*&quot;\u559d&quot; + 0.198*&quot;\u4f4e&quot; + 0.198*&quot;\u8865\u9499&quot; + 0.155*&quot;\u538b\u529b&quot; + 0.155*&quot;\u852c\u83dc&quot; + 0.132*&quot;\u542b\u9499&quot; + 0.132*&quot;\u8840\u9499&quot;&apos;),
 (1,
  u&apos;0.451*&quot;iOS&quot; + 0.451*&quot;\u5f00\u53d1&quot; + 0.322*&quot;\u610f\u4e49&quot; + 0.193*&quot;\u57f9\u8bad&quot; + 0.193*&quot;\u9762\u8bd5&quot; + 0.193*&quot;\u884c\u4e1a&quot; + 0.161*&quot;\u7b97\u6cd5&quot; + 0.129*&quot;\u9ad8\u8003&quot; + 0.129*&quot;\u5e02\u573a&quot; + 0.129*&quot;\u57fa\u7840&quot;&apos;)]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">lsi_vector = lsi[tfidf_vectors]</div><div class="line"><span class="keyword">for</span> vec <span class="keyword">in</span> lsi_vector:</div><div class="line">    <span class="keyword">print</span> vec</div></pre></td></tr></table></figure>
<pre><code>[(0, 0.74917098831536277), (1, -0.0070559356931168236)]
[(0, 0.74809557226254608), (1, -0.054041302062161914)]
[(0, 0.045784366765220297), (1, 0.99846660199817183)]
</code></pre><h4 id="在LSI向量空间中，所有文本的向量都是二维的"><a href="#在LSI向量空间中，所有文本的向量都是二维的" class="headerlink" title="在LSI向量空间中，所有文本的向量都是二维的"></a>在LSI向量空间中，所有文本的向量都是二维的</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">query = tokenization(<span class="string">'/Users/yiiyuanliu/Desktop/nlp/demo/articles/关于降压药的五个问题.txt'</span>)</div><div class="line">query_bow = dictionary.doc2bow(query)</div><div class="line"><span class="keyword">print</span> query_bow</div></pre></td></tr></table></figure>
<pre><code>[(6, 1), (11, 1), (14, 1), (19, 1), (25, 1), (28, 1), (38, 2), (44, 3), (50, 4), (67, 1), (71, 1), (97, 1), (101, 3), (105, 2), (137, 1), (138, 4), (148, 6), (151, 2), (155, 1), (158, 3), (162, 4), (169, 1), (173, 2), (203, 1), (232, 12), (236, 1), (244, 9), (257, 1), (266, 1), (275, 2), (282, 1), (290, 2), (344, 1), (402, 1), (404, 3)]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">query_lsi = lsi[query_bow]</div><div class="line"><span class="keyword">print</span> query_lsi</div></pre></td></tr></table></figure>
<pre><code>[(0, 7.5170080232286249), (1, 0.10900815862153138)]
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">index = similarities.MatrixSimilarity(lsi_vector)</div><div class="line">sims = index[query_lsi]</div><div class="line"><span class="keyword">print</span> list(enumerate(sims))</div></pre></td></tr></table></figure>
<pre><code>[(0, 0.99971396), (1, 0.99625134), (2, 0.060286518)]
</code></pre><h4 id="可以看到LSI的效果很好，一个高血压主题的文本与前两个训练文本的相似性很高，而与iOS主题的第三篇训练文本相似度很低"><a href="#可以看到LSI的效果很好，一个高血压主题的文本与前两个训练文本的相似性很高，而与iOS主题的第三篇训练文本相似度很低" class="headerlink" title="可以看到LSI的效果很好，一个高血压主题的文本与前两个训练文本的相似性很高，而与iOS主题的第三篇训练文本相似度很低"></a>可以看到LSI的效果很好，一个高血压主题的文本与前两个训练文本的相似性很高，而与iOS主题的第三篇训练文本相似度很低</h4><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料:"></a>参考资料:</h3><p><a href="https://www.coursera.org/learn/text-mining" target="_blank" rel="external">Coursera: Text Mining and Analytics</a></p>
<p><a href="http://www.ruanyifeng.com/blog/2013/03/tf-idf.html" target="_blank" rel="external">阮一峰：TF-IDF与余弦相似性的应用（一）：自动提取关键词</a></p>
<p><a href="http://www.52nlp.cn/category/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F" target="_blank" rel="external">如何计算两个文档的相似度</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/04/28/python文本相似度计算/" data-id="cj21y26sl00018zi30ja2hmtl" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-CoreBluetooth连接蓝牙健康设备" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/28/CoreBluetooth连接蓝牙健康设备/" class="article-date">
  <time datetime="2017-03-28T08:00:39.000Z" itemprop="datePublished">2017-03-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS开发/">iOS开发</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/28/CoreBluetooth连接蓝牙健康设备/">CoreBluetooth连接蓝牙健康设备</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>##引言<br>CoreBluetooth是iOS下用于蓝牙设备连接的模块，支持蓝牙4.0及以上的设备。蓝牙设备五花八门，本文的主角是蓝牙健康设备，目标是在iPhone上获取蓝牙健康设备测量到的数据（android手机请看<a href="http://www.jianshu.com/p/f4d9bfcd4594" target="_blank" rel="external">这篇文章</a>）。<br>本文使用的蓝牙健康设备是日本A&amp;D公司生产的蓝牙血压计(UA-651BLE)和体温计（UT-201BLE）。使用这两个型号的健康设备是因为它们是康体佳联盟（continua health alliance）认证的，接口是标准化的，没有进行加密。</p>
<p>##原理<br>在CoreBluetooth中，拥有数据的蓝牙设备被称为peripheral，向外发送数据；获取数据的设备称为central，一般是手机或电脑。本文中central就是我们的手机。<br><img src="http://upload-images.jianshu.io/upload_images/1972331-4fd44cb937888373.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt="蓝牙通信结构"></p>
<p>peripheral会不断广播很小的数据包，包含设备的名称、主要服务等，让外界知道自己的存在。如果有一个central在扫描，就可以获得这个数据包，从而能够去连接这个设备。<br><img src="http://upload-images.jianshu.io/upload_images/1972331-28566d4926c09862.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt="发送广告"></p>
<p>peripheral中最关键的信息就是其包含的service，一个peripheral可以有一个或多个service，每个service下有一个或多个characteristic，用来具体描述这个service。例如，下图是一个心率的service，包含了两个characteristic，分别是心率数值，传感器位置。<br><img src="http://upload-images.jianshu.io/upload_images/1972331-bd077455781315ef.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt="peripheral结构"></p>
<p>##流程<br>了解原理后就可以实践了。我们的手机作为central，在ViewController要实现CBCentralManagerDelegate，之后要操作peripheral，因此也需要实现CBPeripheralDelegate。</p>
<ul>
<li>初始化</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@property (strong, nonatomic) CBCentralManager *centralManager;</div><div class="line"></div><div class="line">self.centralManager = [[CBCentralManager alloc] initWithDelegate:self queue:nil];</div></pre></td></tr></table></figure>
<ul>
<li>扫描设备 第一个array的参数如果填nil就会扫描所有蓝牙设备，推荐用设备包含的服务来过滤（如血压服务）。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">NSString * const BLOOD_PRESSURE_UUID = @&quot;1810&quot;; //血压服务的UUID</div><div class="line"></div><div class="line">[self.centralManager scanForPeripheralsWithServices:[NSArray arrayWithObjects:[CBUUID UUIDWithString:BLOOD_PRESSURE_UUID], nil] options:nil];</div></pre></td></tr></table></figure>
<ul>
<li>扫描到符合要求的蓝牙设备后会调用CBCentralManagerDelegate中下面这个方法 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (void)centralManager:(CBCentralManager *)central didDiscoverPeripheral:(CBPeripheral *)peripheral advertisementData:(NSDictionary&lt;NSString *,id&gt; *)advertisementData RSSI:(NSNumber *)RSSI&#123;</div><div class="line">    if (!peripheral || !peripheral.name || ([peripheral.name isEqualToString:@&quot;&quot;])) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    NSLog(@&quot;name:%@&quot;,peripheral.name);</div><div class="line">    NSLog(@&quot;ad:%@&quot;,advertisementData);</div><div class="line">    [self stopDiscover];  //停止扫描节约电量</div><div class="line">    self.peripheral = peripheral;</div><div class="line">    peripheral.delegate = self;</div><div class="line">    [self.centralManager connectPeripheral:peripheral options:nil]; //尝试连接此设备</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>如果连接成功，会调用CBCentralManagerDelegate的这个方法，在这里去获取此设备的服务。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (void)centralManager:(CBCentralManager *)central didConnectPeripheral:(CBPeripheral *)peripheral&#123;</div><div class="line">    if (!peripheral) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    NSLog(@&quot;did connect peripheral&quot;);</div><div class="line">    [self.peripheral discoverServices:nil]; //尝试发现这个设备的服务</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>成功获取peripheral的服务，就会调用CBPeripheralDelegate的这个方法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (void)peripheral:(CBPeripheral *)peripheral didDiscoverServices:(NSError *)error&#123;</div><div class="line">    for (CBService *service in peripheral.services) &#123;  //遍历服务</div><div class="line">        NSLog(@&quot;discover service: %@&quot;, service);</div><div class="line">        if ([service.UUID isEqual:[CBUUID UUIDWithString:BLOOD_PRESSURE_UUID]] ) &#123;</div><div class="line">            [peripheral discoverCharacteristics:nil forService:service];  //如果是血压服务，就尝试发现这个服务的characteristic</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>成功发现characteristic后，调用CBPeripheralDelegate的这个方法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">- (void)peripheral:(CBPeripheral *)peripheral didDiscoverCharacteristicsForService:(CBService *)service error:(NSError *)error&#123;</div><div class="line">    for (CBCharacteristic *character in service.characteristics) &#123;</div><div class="line">        NSLog(@&quot;discover characteristic: %@&quot;,character);</div><div class="line">        if ([character.UUID isEqual:[CBUUID UUIDWithString:BLOOD_PRESSURE_MEASUREMENT_UUID]]) &#123;</div><div class="line">            //监听我们关注的characteristic，一旦这个//发生变化就会得到通知</div><div class="line">            [peripheral setNotifyValue:YES forCharacteristic:character];</div><div class="line">        &#125;</div><div class="line">        if ([character.UUID isEqual:[CBUUID UUIDWithString:BLOOD_PRESSURE_FEATURE_UUID]]) &#123;</div><div class="line">            //读取characteristic的值</div><div class="line">            [peripheral readValueForCharacteristic:character];</div><div class="line">        &#125;</div><div class="line">        if ([character.UUID isEqual:[CBUUID UUIDWithString:DATE_TIME_UUID]]) &#123;</div><div class="line">            [peripheral readValueForCharacteristic:character];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>设备测量完成后会发送数据，获得数据后调用CBPeripheralDelegate的这个方法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">- (void)peripheral:(CBPeripheral *)peripheral didUpdateValueForCharacteristic:(CBCharacteristic *)characteristic error:(NSError *)error&#123;</div><div class="line">    if (error) &#123;</div><div class="line">        NSLog(@&quot;%@&quot;,[error localizedDescription]);</div><div class="line">    &#125;else&#123;</div><div class="line">        NSData *data = characteristic.value;  //获取raw data</div><div class="line">        if ([characteristic.UUID isEqual:[CBUUID UUIDWithString:BLOOD_PRESSURE_MEASUREMENT_UUID]] &amp;&amp; data) &#123;</div><div class="line">            const uint8_t *reportData = [data bytes];  //转换一个字节对应一个整数的序列  </div><div class="line">            NSInteger sys = reportData[1];  //收缩压</div><div class="line">            NSInteger dia = reportData[3];  //舒张压</div><div class="line">            NSInteger pul = reportData[7];  //心率</div><div class="line">            NSLog(@&quot;sys:%ld&quot;,(long)sys);</div><div class="line">            NSLog(@&quot;dia:%ld&quot;,(long)dia);</div><div class="line">            NSLog(@&quot;pul:%ld&quot;,(long)pul);</div><div class="line">            if (sys == 255) &#123;</div><div class="line">                self.sysTextField.text = @&quot;error&quot;;</div><div class="line">                self.diaTextField.text = @&quot;error&quot;;</div><div class="line">                self.pulTextField.text = @&quot;error&quot;;</div><div class="line">            &#125;else&#123;</div><div class="line">                self.sysTextField.text = [NSString stringWithFormat:@&quot;%ld&quot;,sys];</div><div class="line">                self.diaTextField.text = [NSString stringWithFormat:@&quot;%ld&quot;,dia];</div><div class="line">                self.pulTextField.text = [NSString stringWithFormat:@&quot;%ld&quot;,pul];</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">        &#125;else&#123;</div><div class="line">            NSLog(@&quot;data value: %@ UUID:%@&quot;,data, characteristic.UUID);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>##运行截图</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1972331-28822d825664f6f4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/240" alt="血压测量界面"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1972331-d31dfe2a9e1f7cd9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/240" alt="体温测量界面"></p>
<p>##源码<br><a href="https://github.com/michael0905/CoreBluetoothDemo" target="_blank" rel="external">Github项目地址</a><br>欢迎讨论，一起学习！喜欢请给star</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/28/CoreBluetooth连接蓝牙健康设备/" data-id="cj21y26sp00038zi3m6doyn8w" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-AFNetworking 3.x 使用心得" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/28/AFNetworking 3.x 使用心得/" class="article-date">
  <time datetime="2017-03-28T07:59:36.000Z" itemprop="datePublished">2017-03-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS开发/">iOS开发</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/28/AFNetworking 3.x 使用心得/">WordNet</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>AFNetworking毫无疑问是目前iOS开发中（Objective-C）最好的第三方网络库。一般规模的app使用AFNetworking就可以完成所有需求，不需要自己造轮子。<br>在使用AFNetworking的过程中遇到了许多坑，也获得了不少经验，在这里总结一下，希望能够帮助到大家。</p>
<p>##AFNetworking进一步封装<br>AFNetworking 3.x 已经为我们提供了丰富而且易用的API，但还是不够。AFNetworking是一个通用的库，而在我们自己的项目中，有特定的需求，而且往往在许多类中都需要用到网络请求。对AFNetworking进一步封装，能够大大简化代码，减少重复。<br>举个例子，新建一个CDMNetworkManager类，继承AFHTTPSessionManager。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">//CDMNetworkManager.h</div><div class="line">#import &lt;AFNetworking/AFNetworking.h&gt;</div><div class="line"></div><div class="line">typedef void(^requestSuccessBlock) (NSURLSessionTask *task, id resposeObject);</div><div class="line">typedef void(^requestFailureBlock) (NSURLSessionTask *task, NSError *error);</div><div class="line"></div><div class="line">@interface CDMNetworkManager : AFHTTPSessionManager</div><div class="line">+(instancetype)sharedManager;</div><div class="line">-(void)sendPostRequest:(NSString *)path parameters:(NSDictionary *)parameters success:(requestSuccessBlock)success failure:(requestFailureBlock)failure;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">//CDMNetworkManager.m</div><div class="line">#import &quot;CDMNetworkManager.h&quot;</div><div class="line"></div><div class="line">typedef void(^requestSuccessBlock) (NSURLSessionTask *task, id resposeObject);</div><div class="line">typedef void(^requestFailureBlock) (NSURLSessionTask *task, NSError *error);</div><div class="line"></div><div class="line">@implementation CDMNetworkManager</div><div class="line"></div><div class="line">+(instancetype)sharedManager&#123;</div><div class="line">    static CDMNetworkManager *manager = nil;</div><div class="line">    </div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">       manager = [[self alloc] initWithBaseURL:[NSURL URLWithString:@&quot;http://www.someurl.com/&quot;]];</div><div class="line"></div><div class="line">    &#125;);</div><div class="line">    return manager;</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(void)sendPostRequest:(NSString *)path parameters:(NSDictionary *)parameters success:(requestSuccessBlock)success failure:(requestFailureBlock)failure&#123;</div><div class="line">    [self POST:path parameters:parameters progress:nil success:^(NSURLSessionTask *task, id responseObject)&#123;</div><div class="line">        success(task,responseObject);</div><div class="line">    &#125; failure:^(NSURLSessionTask *task, NSError *error)&#123;</div><div class="line">        failure(task,error);</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>初始化方法中使用了单例模式，这样与服务器的连接不会断掉，省去了每次建立连接时三次握手等过程。如果有多个URL地址，可以创建多个单例。如果有更多特殊的要求，比如设置超时时间等，可以在这个方法中设置。<br>具体的网络请求方法这里只封装了一个简单的post方法，如果有需要可以封装别的方法。<br>调用的时候很简单，在任何一个需要发送post请求的类中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[[CDMNetworkManager sharedManager] sendPostRequest:@&quot;XXX&quot; parameters:parameter success:^(NSURLSessionTask *task, id responseObject)&#123;</div><div class="line">        //your code</div><div class="line">    &#125; failure:^(NSURLSessionTask *task, NSError *error)&#123;</div><div class="line">        // your code</div><div class="line">    &#125;];</div></pre></td></tr></table></figure></p>
<h2 id="调试工具"><a href="#调试工具" class="headerlink" title="调试工具"></a>调试工具</h2><p>曾经我每次网络请求调试的时候只会在回调里写log，然后在控制台里一行一行的仔细查找。如果这个请求返回的内容很多，在Xcode里的显示效果就很差，而且不能直接显示中文。体验很差！</p>
<p>这时候需要神器<a href="https://www.charlesproxy.com/" target="_blank" rel="external">Charles</a></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1972331-39e2e19c7040a3b9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>上面是Charles的截图，能够监听Mac的所有网络请求并且显示各种格式的内容，非常好用。如果用模拟器的话就可以直接用Charles抓包，如果真机调试的话，需要设置一下iPhone，网上也有很多教程。<br>虽然是付费软件，但是不买license只是打开时会有10秒延时，每隔30分钟自动关闭。</p>
<p>##常见错误<br>Error Domain=com.alamofire.error.serialization.response Code=-1016 “Request failed: unacceptable content-type: text/html” </p>
<p>出现这个问题的原因有很多，从表面上看是返回数据的格式不支持text/html，但是为什么返回了text/html？原因不唯一。<br>首先要看请求的response code，如果是200，说明请求已经传到服务器并且成功返回，返回的格式是text/html。AFNetworking的默认response serializer是AFJSONResponseSerializer，不支持text/html。<br>这时需要在manager的初始化方法中增加一下代码。或者与服务器开发人员沟通，改写服务器端。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">manager.responseSerializer.acceptableContentTypes = [manager.responseSerializer.acceptableContentTypes setByAddingObject:@&quot;text/html&quot;];</div></pre></td></tr></table></figure></p>
<p>如果response code是400，说明服务器根本没有收到请求。这时为什么返回了一个text/html的数据呢？返回的数据在Xcode控制台上显示为16进制，但是在Charles里我们可以看到结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</div><div class="line">&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</div><div class="line">  &lt;head&gt;</div><div class="line">    &lt;title&gt;请求错误&lt;/title&gt;</div><div class="line">    &lt;style&gt;BODY &#123; color: #000000; background-color: white; font-family: Verdana; margin-left: 0px; margin-top: 0px; &#125; #content &#123; margin-left: 30px; font-size: .70em; padding-bottom: 2em; &#125; A:link &#123; color: #336699; font-weight: bold; text-decoration: underline; &#125; A:visited &#123; color: #6699cc; font-weight: bold; text-decoration: underline; &#125; A:active &#123; color: #336699; font-weight: bold; text-decoration: underline; &#125; .heading1 &#123; background-color: #003366; border-bottom: #336699 6px solid; color: #ffffff; font-family: Tahoma; font-size: 26px; font-weight: normal;margin: 0em 0em 10px -20px; padding-bottom: 8px; padding-left: 30px;padding-top: 16px;&#125; pre &#123; font-size:small; background-color: #e5e5cc; padding: 5px; font-family: Courier New; margin-top: 0px; border: 1px #f0f0e0 solid; white-space: pre-wrap; white-space: -pre-wrap; word-wrap: break-word; &#125; table &#123; border-collapse: collapse; border-spacing: 0px; font-family: Verdana;&#125; table th &#123; border-right: 2px white solid; border-bottom: 2px white solid; font-weight: bold; background-color: #cecf9c;&#125; table td &#123; border-right: 2px white solid; border-bottom: 2px white solid; background-color: #e5e5cc;&#125;&lt;/style&gt;</div><div class="line">  &lt;/head&gt;</div><div class="line">  &lt;body&gt;</div><div class="line">    &lt;div id=&quot;content&quot;&gt;</div><div class="line">      &lt;p class=&quot;heading1&quot;&gt;请求错误&lt;/p&gt;</div><div class="line">      &lt;p xmlns=&quot;&quot;&gt;服务器处理请求时遇到错误。有关构造有效服务请求的内容，请参阅&lt;a rel=&quot;help-page&quot; href=&quot;http://www.zjubiomedit.com:13264/HypertensionService.svc/help&quot;&gt;服务帮助页&lt;/a&gt;。&lt;/p&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">  &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>这是自动返回的一个错误页面，而不是服务器返回的数据格式不对。这时候再去找response serializer的问题就南辕北辙了。</p>
<p>那么为什么服务器没有受到请求？<br>一种可能是baseURL的问题。AFHTTPSessionManager的初始化中用到了baseURL，与之后的path拼接时可能出错，检查一下。<br>还有可能是request serializer的问题。AFNetworking默认的是AFHTTPRequestSerializer。如果服务器接受的参数只能是json的话，需要使用AFJSONRequestSerializer。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">self.requestSerializer = [AFJSONRequestSerializer serializer];</div></pre></td></tr></table></figure></p>
<p>可能还有其他各种各样奇怪的原因，欢迎大家补充。</p>
<p>作者时间、能力有限，文章难免有不足之处，请大家指正。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/28/AFNetworking 3.x 使用心得/" data-id="cj21y26si00008zi3e2511bon" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Android蓝牙健康设备开发：Health Device Profile(HDP)" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/28/Android蓝牙健康设备开发：Health Device Profile(HDP)/" class="article-date">
  <time datetime="2017-03-28T07:57:47.000Z" itemprop="datePublished">2017-03-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android开发/">Android开发</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/28/Android蓝牙健康设备开发：Health Device Profile(HDP)/">Android蓝牙健康设备开发：Health Device Profile(HDP)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近按导师的要求做了个小项目：用Android手机跟蓝牙血压计通信。在网上查了很多资料，发现有许多文章是讲解Android蓝牙开发，但是在中文社区缺少针对实现HDP profile的蓝牙健康设备的文章，所以整理了相关知识和代码做一个总结。做了一点微小的贡献，谢谢大家。<br>1、相关概念<br>HDP：Health Device Profile顾名思义是针对蓝牙健康设备（如蓝牙血压计、蓝牙体重秤）的一个profile，由蓝牙技术联盟（Bluetooth SIG）发布。并不是所有蓝牙设备都可以采用HDP，只有经典蓝牙（BR/EDR）设备才可以。低功耗蓝牙设备，即蓝牙4.0及以上，采用的是GATT等profile。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1972331-d1818590b10765c2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>上图是HDP的协议栈。在通信时，蓝牙健康设备作为source，Android手机作为sink。图中L2CAP、SDP、MCAP是蓝牙通信的底层协议，中间是IEEE11073协议。11073是IEEE发布的一个健康设备的协议簇，其下包含了许多不同种类的健康设备协议，如11073-10407是血压计的协议。在数据传输时，手机与健康设备根据此协议来发送请求、解析数据等。最上层的application在本文中自然指的就是Android app。<br>Android蓝牙模块：android.bluetooth是蓝牙的开发包，里面包含了所有蓝牙相关的类，无论是经典蓝牙还是低功耗蓝牙。其中，本文重点关注的是BluetoothHealth这个类，还用到了一些蓝牙基础类BluetoothAdapter BluetoothDevice等，在这里就不展开介绍了。BluetoothHealth是在API14时引入的，所以系统版本高于14的Android手机都可以与采用HDP的健康设备通信。BluetoothHealth中包括了与HDP设备建立通信的API，具体请参见<a href="https://developer.android.com/reference/android/bluetooth/BluetoothHealth.html" target="_blank" rel="external">官方文档</a>。在官方文档中有一个建立通信的流程：<br>1、调用<a href="https://developer.android.com/reference/android/bluetooth/BluetoothAdapter.html#getProfileProxy(android.content.Context, android.bluetooth.BluetoothProfile.ServiceListener, int" target="_blank" rel="external">getProfileProxy(Context, BluetoothProfile.ServiceListener, int)</a>)来获取代理对象的连接。<br>2、创建BluetoothHealthCallback回调，调用<a href="https://developer.android.com/reference/android/bluetooth/BluetoothHealth.html#registerSinkAppConfiguration(java.lang.String, int, android.bluetooth.BluetoothHealthCallback" target="_blank" rel="external">registerSinkAppConfiguration(String, int, BluetoothHealthCallback)</a>)注册一个sink端的应用程序配置。<br>3、将手机与健康设备配对，这一步一般在手机的“设置”中完成。<br>4、使用<a href="https://developer.android.com/reference/android/bluetooth/BluetoothHealth.html#connectChannelToSource(android.bluetooth.BluetoothDevice, android.bluetooth.BluetoothHealthAppConfiguration" target="_blank" rel="external">connectChannelToSource(BluetoothDevice, BluetoothHealthAppConfiguration)</a>)来建立一个与健康设备的通信channel。有的设备会自动建立通信，不需要在代码中调用这个方法。第二步中的回调会指示channel的状态变化。<br>5、用ParcelFileDescriptor来读取健康设备传来的数据，并根据IEEE 11073来解析数据。<br>6、通信结束后，关闭通信channel，注销应用程序配置。<br>看完这个流程是不是一脸懵逼？不要慌，这里官方文档实在太抽象了，必须要配合实际的代码才能看懂。<br>2、demo代码<br>项目的目标是与经典蓝牙血压计进行通信，获取血压计测量的数值和日期。这里血压计的型号是A&amp;D UA-767PBT-C。项目中的代码是以github上<a href="https://github.com/andengineering/A-D-HDP-Android-Demo" target="_blank" rel="external">这个项目</a>为基础，根据需求进行修改而实现的。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1972331-4b89d2b3d45c3799.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="">项目结构</p>
<p>上图是项目的结构，非常简单，只有一个activity和一个service。activity与用户交互，service绑定在activity中与蓝牙血压计建立通信、交换数据。<br>首先AndroidManifest.xml中注册蓝牙权限：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:name=&quot;android.permission.BLUETOOTH&quot; /&gt;</div><div class="line">&lt;uses-permission android:name=&quot;android.permission.BLUETOOTH_ADMIN&quot;/&gt;</div></pre></td></tr></table></figure></p>
<p>##MainActivity<br>主要作用是显示血压计传过来的数据，以及绑定服务。<br>activity的布局如下：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1972331-4e3639c3eb79df27.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="demo.png"></p>
<p>上半部分是一个ArrayList,用于显示手机所配对的蓝牙设备的名称和Mac地址。下半部分会显示一次血压测量的参数：收缩压、舒张压、心率、测量时间。</p>
<p>在MainActivity中一些重要私有变量：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">private static final int REQUEST_ENABLE_BT = 1;  //用于打开手机蓝牙</div><div class="line">private static final int HEALTH_PROFILE_SOURCE_DATA_TYPE = 0x1007;  //IEEE 11073中规定的血压数据类型</div><div class="line">private BluetoothAdapter mBluetoothAdapter;</div><div class="line">private Messenger mHealthService;  //用于与service通信</div><div class="line">private boolean mHealthServiceBound; //用于判断service是否与此activity绑定</div></pre></td></tr></table></figure></p>
<p>打开蓝牙：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">if (!mBluetoothAdapter.isEnabled()) &#123;</div><div class="line">     Intent enableIntent = new Intent(</div><div class="line">             BluetoothAdapter.ACTION_REQUEST_ENABLE);</div><div class="line">     startActivityForResult(enableIntent, REQUEST_ENABLE_BT);</div><div class="line"> &#125; else &#123;</div><div class="line">     initialize();</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>启动服务:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">// Sets up communication with HDPService.</div><div class="line">private ServiceConnection mConnection = new ServiceConnection() &#123;</div><div class="line">    public void onServiceConnected(ComponentName name, IBinder service) &#123;</div><div class="line">        mHealthServiceBound = true;</div><div class="line">        Message msg = Message.obtain(null,</div><div class="line">                HDPService.MSG_REG_CLIENT);</div><div class="line">        msg.replyTo = mMessenger;</div><div class="line">        mHealthService = new Messenger(service);</div><div class="line">        try &#123;</div><div class="line">            mHealthService.send(msg);</div><div class="line">            //register blood pressure data type</div><div class="line">            sendMessage(HDPService.MSG_REG_HEALTH_APP,</div><div class="line">                    HEALTH_PROFILE_SOURCE_DATA_TYPE);</div><div class="line">        &#125; catch (RemoteException e) &#123;</div><div class="line">            Log.w(TAG, &quot;Unable to register client to service.&quot;);</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    public void onServiceDisconnected(ComponentName name) &#123;</div><div class="line">        mHealthService = null;</div><div class="line">        mHealthServiceBound = false;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">private void initialize() &#123;</div><div class="line">    // Starts health service.</div><div class="line">    Intent intent = new Intent(this, HDPService.class);</div><div class="line">    //startService(intent);</div><div class="line">    bindService(intent, mConnection, Context.BIND_AUTO_CREATE);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>用handler和message来实现activity与service的通信：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">private Handler mIncomingHandler = new Handler() &#123;</div><div class="line">    @Override</div><div class="line">    public void handleMessage(Message msg) &#123;</div><div class="line">        switch (msg.what) &#123;</div><div class="line">          ......</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">private final Messenger mMessenger = new Messenger(mIncomingHandler);</div></pre></td></tr></table></figure></p>
<p>##HDPService<br>这个service是核心部分，手机与蓝牙血压计的通信就是在此实现的。<br>service中部分重要私有变量:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">private BluetoothHealthAppConfiguration mHealthAppConfig; //BluetoothHealthAppConfiguration</div><div class="line">private BluetoothAdapter mBluetoothAdapter;  //BluetoothAdapter</div><div class="line">private BluetoothHealth mBluetoothHealth;  //代理对象</div></pre></td></tr></table></figure></p>
<p>在service中按照官方文档的流程一步一步实现与蓝牙血压计的通信。<br>1、获取代理对象：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">public void onCreate() &#123;</div><div class="line">    super.onCreate();</div><div class="line">    mBluetoothAdapter = BluetoothAdapter.getDefaultAdapter();</div><div class="line">    if (mBluetoothAdapter == null || !mBluetoothAdapter.isEnabled()) &#123;</div><div class="line">        // Bluetooth adapter isn&apos;t available.  The client of the service is supposed to</div><div class="line">        // verify that it is available and activate before invoking this service.</div><div class="line">        stopSelf();</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    if (!mBluetoothAdapter.getProfileProxy(this, mBluetoothServiceListener,</div><div class="line">            BluetoothProfile.HEALTH)) &#123;</div><div class="line">        Toast.makeText(this, &quot;HDP not available&quot;,</div><div class="line">                Toast.LENGTH_LONG).show();</div><div class="line">        stopSelf();</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>代码中的mBluetoothServiceListener是一个回调，如果getProfileProxy方法返回为真，就进入回调。在回调中获取了代理对象属于BluetoothHealth类的proxy。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">private final BluetoothProfile.ServiceListener mBluetoothServiceListener =</div><div class="line">            new BluetoothProfile.ServiceListener() &#123;</div><div class="line">                public void onServiceConnected(int profile, BluetoothProfile proxy) &#123;</div><div class="line">                    if (profile == BluetoothProfile.HEALTH) &#123;</div><div class="line">                        mBluetoothHealth = (BluetoothHealth) proxy;</div><div class="line">                        Log.d(TAG, &quot;onServiceConnected to profile: &quot; + profile);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                public void onServiceDisconnected(int profile) &#123;</div><div class="line">                    if (profile == BluetoothProfile.HEALTH) &#123;</div><div class="line">                        mBluetoothHealth = null;</div><div class="line">                    &#125;</div><div class="line">                    Log.d(TAG, &quot;onServiceDisconnected&quot;);</div><div class="line">                &#125;</div><div class="line">            &#125;;</div></pre></td></tr></table></figure></p>
<p>2、注册BluetoothHealthAppConfiguration:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mBluetoothHealth.registerSinkAppConfiguration(TAG, dataType, mHealthCallback);</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">private final BluetoothHealthCallback mHealthCallback = new BluetoothHealthCallback() &#123;</div><div class="line">        // Callback to handle application registration and unregistration events.  The service</div><div class="line">        // passes the status back to the UI client.</div><div class="line">        public void onHealthAppConfigurationStatusChange(BluetoothHealthAppConfiguration config,</div><div class="line">                                                         int status) &#123;</div><div class="line">            if (status == BluetoothHealth.APP_CONFIG_REGISTRATION_FAILURE) &#123;</div><div class="line">                mHealthAppConfig = null;</div><div class="line">                sendMessage(STATUS_HEALTH_APP_REG, RESULT_FAIL, null);</div><div class="line">                Log.d(TAG, &quot;APP_CONFIG_REGISTRATION_FAILURE&quot;);</div><div class="line">            &#125; else if (status == BluetoothHealth.APP_CONFIG_REGISTRATION_SUCCESS) &#123;</div><div class="line">                mHealthAppConfig = config;</div><div class="line">                sendMessage(STATUS_HEALTH_APP_REG, RESULT_OK, null);</div><div class="line">                Log.d(TAG, &quot;APP_CONFIG_REGISTRATION_SUCCESS&quot;);</div><div class="line">            &#125; else if (status == BluetoothHealth.APP_CONFIG_UNREGISTRATION_FAILURE ||</div><div class="line">                    status == BluetoothHealth.APP_CONFIG_UNREGISTRATION_SUCCESS) &#123;</div><div class="line">                sendMessage(STATUS_HEALTH_APP_UNREG,</div><div class="line">                        status == BluetoothHealth.APP_CONFIG_UNREGISTRATION_SUCCESS ?</div><div class="line">                                RESULT_OK : RESULT_FAIL, null);</div><div class="line">                Log.d(TAG, &quot;UNREGISTRATION&quot;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Callback to handle channel connection state changes.</div><div class="line">        // Note that the logic of the state machine may need to be modified based on the HDP device.</div><div class="line">        // When the HDP device is connected, the received file descriptor is passed to the</div><div class="line">        // ReadThread to read the content.</div><div class="line">        public void onHealthChannelStateChange(BluetoothHealthAppConfiguration config,</div><div class="line">                                               BluetoothDevice device, int prevState, int newState, ParcelFileDescriptor fd,</div><div class="line">                                               int channelId) &#123;</div><div class="line">//            if (Log.isLoggable(TAG, Log.DEBUG))</div><div class="line">            Log.d(TAG, String.format(&quot;prevState\t%d ----------&gt; newState\t%d&quot;,</div><div class="line">                    prevState, newState));</div><div class="line">            if (prevState == BluetoothHealth.STATE_CHANNEL_CONNECTING &amp;&amp;</div><div class="line">                    newState == BluetoothHealth.STATE_CHANNEL_CONNECTED) &#123;</div><div class="line">                if (config.equals(mHealthAppConfig)) &#123;</div><div class="line">                    mChannelId = channelId;</div><div class="line">                    sendMessage(STATUS_CREATE_CHANNEL, RESULT_OK, null);</div><div class="line">                    (new ReadThread(fd)).start();</div><div class="line">                &#125; else &#123;</div><div class="line">                    sendMessage(STATUS_CREATE_CHANNEL, RESULT_FAIL, null);</div><div class="line">                &#125;</div><div class="line">            &#125; else if (prevState == BluetoothHealth.STATE_CHANNEL_CONNECTING &amp;&amp;</div><div class="line">                    newState == BluetoothHealth.STATE_CHANNEL_DISCONNECTED) &#123;</div><div class="line">                sendMessage(STATUS_CREATE_CHANNEL, RESULT_FAIL, null);</div><div class="line">            &#125; else if (newState == BluetoothHealth.STATE_CHANNEL_DISCONNECTED) &#123;</div><div class="line">                Log.d(TAG, &quot;I&apos;m in State Channel Disconnected.&quot;);</div><div class="line">                if (config.equals(mHealthAppConfig)) &#123;</div><div class="line">                    sendMessage(STATUS_DESTROY_CHANNEL, RESULT_OK, null);</div><div class="line"></div><div class="line">                &#125; else &#123;</div><div class="line">                    sendMessage(STATUS_DESTROY_CHANNEL, RESULT_FAIL, null);</div><div class="line">                &#125;</div><div class="line">            &#125; else if (prevState == BluetoothHealth.STATE_CHANNEL_DISCONNECTED &amp;&amp;</div><div class="line">                    newState == BluetoothHealth.STATE_CHANNEL_CONNECTED) &#123;</div><div class="line">                if (config.equals(mHealthAppConfig)) &#123;</div><div class="line">                    mChannelId = channelId;</div><div class="line">                    sendMessage(STATUS_CREATE_CHANNEL, RESULT_OK, null);</div><div class="line">                    (new ReadThread(fd)).start();</div><div class="line">                &#125; else &#123;</div><div class="line">                    sendMessage(STATUS_CREATE_CHANNEL, RESULT_FAIL, null);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<p>mHealthCallback是其中的关键，有两个方法onHealthAppConfigurationStatusChange和onHealthChannelStateChange。<br>onHealthAppConfigurationStatusChange回调会监听AppConfiguration的状态，会在registerSinkAppConfiguration函数返回后调用。<br>onHealthChannelStateChange回调会监听与source端（在这里也就是血压计）通信通道的状态变化，如果收到发来的数据，会接收到一个ParcelFileDescriptor用于读取。</p>
<p>3、将手机与健康设备配对<br>这一步在手机的系统设置中进行，不必严格按照这个流程的顺序，可以事先配对好。</p>
<p>4、建立通信通道<br>这一步不是所有设备都需要，部分设备会自动建立通道与sink端（手机）进行通信。我们所用的这个蓝牙血压计就是如此，会自动建立通道。<br>如果不能自动建立通信，可以主动调用如下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mBluetoothHealth.connectChannelToSource(mDevice, mHealthAppConfig);</div></pre></td></tr></table></figure></p>
<p>mDevice是将要建立通信的source端，可以用mBluetoothAdapter获取与手机配对的任一设备。</p>
<p>5、读取、解析数据<br>在与蓝牙设备通信时，我们需要知道一点：通信是双向的，设备会向手机发信息，手机可以也需要向设备发信息。在service中建了两个线程，一个用于读数据，一个用于写数据，通过这两个线程实现与设备的数据交换。</p>
<p>首先看读线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">private class ReadThread extends Thread &#123;</div><div class="line">    private ParcelFileDescriptor mFd;</div><div class="line"></div><div class="line">    public ReadThread(ParcelFileDescriptor fd) &#123;</div><div class="line">        super();</div><div class="line">        mFd = fd;</div><div class="line">        Log.i(TAG, &quot;read thread&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void run() &#123;</div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>读线程的调用是在回调方法onHealthChannelStateChange中的，当判断通信通道打开时，会开启一个读线程，并且将回调中提供的ParcelFileDescriptor传入读线程的构造方法，用于读取数据。<br>具体的读取和解析过程我们来看run方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line">FileInputStream fis = new FileInputStream(mFd.getFileDescriptor());</div><div class="line">            byte data[] = new byte[300]; //假定有300byte的数据</div><div class="line">            try &#123;</div><div class="line">                while (fis.read(data) &gt; -1) &#123;</div><div class="line">                    if (data[0] != (byte) 0x00) &#123;</div><div class="line">                        String test = byte2hex(data);</div><div class="line">                        Log.i(TAG, &quot;test: &quot; + test);</div><div class="line">                        if (data[0] == (byte) 0xE2) &#123;</div><div class="line">                            Log.i(TAG, &quot;E2&quot;);</div><div class="line">                            //data_AR</div><div class="line">                            count = 1;</div><div class="line">                            (new WriteThread(mFd)).start();</div><div class="line">                            try &#123;</div><div class="line">                                sleep(100);</div><div class="line">                            &#125; catch (InterruptedException e) &#123;</div><div class="line">                                e.printStackTrace();</div><div class="line">                            &#125;</div><div class="line">                            count = 2;</div><div class="line">                            (new WriteThread(mFd)).start();</div><div class="line">                        &#125; else if (data[0] == (byte) 0xE7) &#123;</div><div class="line">                            Log.i(TAG, &quot;E7&quot;);</div><div class="line">                            if (data[18] == (byte) 0x0d &amp;&amp; data[19] == (byte) 0x1d)  //fixed report</div><div class="line">                            &#123;</div><div class="line">                                count = 3;</div><div class="line">                                //set invoke id so get correct response</div><div class="line">                                invoke = new byte[]&#123;data[6], data[7]&#125;;</div><div class="line">                                //write back response</div><div class="line">                                (new WriteThread(mFd)).start();</div><div class="line">                                //parse data!!</div><div class="line"></div><div class="line">                                int length = data[21];</div><div class="line">                                Log.i(TAG, &quot;length is &quot; + length);</div><div class="line">                                int number_of_data_packets = data[22 + 5]; //03</div><div class="line">                                //packet_start starts from handle 0 byte</div><div class="line">                                int packet_start = 30; </div><div class="line">                                final int SYS_DIA_MAP_DATA = 1;</div><div class="line">                                final int PULSE_DATA = 2;</div><div class="line">                                final int ERROR_CODE_DATA = 3;</div><div class="line">                                for (int i = 0; i &lt; number_of_data_packets; i++) &#123;</div><div class="line">                                    int obj_handle = data[packet_start + 1]; </div><div class="line">                                    switch (obj_handle) &#123;</div><div class="line">                                        case SYS_DIA_MAP_DATA:</div><div class="line">                                            int sys = byteToUnsignedInt(data[packet_start + 9]);</div><div class="line">                                            int dia = byteToUnsignedInt(data[packet_start + 11]);</div><div class="line">                                            int map = byteToUnsignedInt(data[packet_start + 13]);</div><div class="line">                                            //create team string... 9+13~9+20</div><div class="line">                                            Log.i(TAG, &quot;sys is &quot; + sys);</div><div class="line">                                            sendMessage(RECEIVED_SYS, sys, null);</div><div class="line">                                            Log.i(TAG, &quot;dia is &quot; + dia);</div><div class="line">                                            sendMessage(RECEIVED_DIA, dia, null);</div><div class="line">                                            Log.i(TAG, &quot;map is &quot; + map);</div><div class="line">                                            break;</div><div class="line">                                        case PULSE_DATA:</div><div class="line">                                            //parse</div><div class="line">                                            int pulse = byteToUnsignedInt(data[packet_start + 5]);</div><div class="line">                                            Log.i(TAG, &quot;pulse is &quot; + pulse);</div><div class="line">                                            sendMessage(RECEIVED_PUL, pulse, null);</div><div class="line">                                            String month = byteToString(data[packet_start + 8]);</div><div class="line">                                            String day = byteToString(data[packet_start + 9]);</div><div class="line">                                            String year = byteToString(data[packet_start + 6]) + byteToString(data[packet_start + 7]);</div><div class="line">                                            String hour = byteToString(data[packet_start + 10]);</div><div class="line">                                            String minute = byteToString(data[packet_start + 11]);</div><div class="line">                                            String date = year + &quot;.&quot; + month + &quot;.&quot; + day + &quot; &quot; + hour + &quot;:&quot; + minute;</div><div class="line">                                            Log.v(TAG, &quot;the date is &quot; + date);</div><div class="line">                                            sendMessage(RECEIVED_DATE, 0, date);</div><div class="line">                                            break;</div><div class="line">                                        case ERROR_CODE_DATA:</div><div class="line">                                            //need more signal</div><div class="line">                                            break;</div><div class="line">                                    &#125;</div><div class="line">                                    packet_start += 4 + data[packet_start + 3];    //4 = ignore beginning four bytes</div><div class="line">                                &#125;</div><div class="line">                            &#125; else &#123;</div><div class="line">                                count = 2;</div><div class="line">                            &#125;</div><div class="line">                        &#125; else if (data[0] == (byte) 0xE4) &#123;</div><div class="line">                            count = 4;</div><div class="line">                            (new WriteThread(mFd)).start();</div><div class="line">                        &#125;</div><div class="line">                        //zero out the data</div><div class="line">                        for (int i = 0; i &lt; data.length; i++) &#123;</div><div class="line">                            data[i] = (byte) 0x00;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    sendMessage(STATUS_READ_DATA, 0, null);</div><div class="line">                &#125;</div><div class="line">            &#125; catch (IOException ioe) &#123;</div><div class="line">            &#125;</div><div class="line">            if (mFd != null) &#123;</div><div class="line">                try &#123;</div><div class="line">                    mFd.close();</div><div class="line">                &#125; catch (IOException e) &#123; /* Do nothing. */ &#125;</div><div class="line">            &#125;</div><div class="line">            sendMessage(STATUS_READ_DATA_DONE, 0, null);</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>while循环中是对读取数据的解析，这里的解析必须参考IEEE 11073中的内容。这个demo用到了血压计，因此就要使用IEEE 11073－10407（专门针对血压计的协议）。使用其他类型的设备也就要使用相应的IEEE 11073－xxxxx协议。<br>回到demo中的数据读取和解析，这是一个根据IEEE 11073－10407进行手机与蓝牙设备互相发送数据的过程，下图是运行的log：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1972331-3d16b1f565818953.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="log.png"></p>
<p>大致解释一下流程：<br>按下测量按钮后，蓝牙血压计发来一个e2开头的数据，这是一个请求连接的信号。<br>收到请求连接后，手机用写线程发送给血压计一个回复同意连接，接着再发送一个数据请求血压计的特征。<br>血压计发来一个e7开头的数据，回复血压计的特征。<br>测量完毕后，血压计发来一个e7开头的数据，是这次测量的报告。<br>手机回复确认收到测量数据。<br>血压计发来一个e4开头的数据，请求断开连接。<br>手机回复确认断开连接。</p>
<p>想要查看详细数据请看IEEE 11073－10407！请看IEEE 11073－10407！请看IEEE 11073－10407！</p>
<p>接下去是写线程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line">private class WriteThread extends Thread &#123;</div><div class="line">        private ParcelFileDescriptor mFd;</div><div class="line"></div><div class="line">        public WriteThread(ParcelFileDescriptor fd) &#123;</div><div class="line">            super();</div><div class="line">            mFd = fd;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void run() &#123;</div><div class="line">            FileOutputStream fos = new FileOutputStream(mFd.getFileDescriptor());</div><div class="line">//        	Association Response [0xE300]</div><div class="line">            final byte data_AR[] = new byte[]&#123;(byte) 0xE3, (byte) 0x00,</div><div class="line">                    (byte) 0x00, (byte) 0x2C,</div><div class="line">                    (byte) 0x00, (byte) 0x00,</div><div class="line">                    (byte) 0x50, (byte) 0x79,</div><div class="line">                    (byte) 0x00, (byte) 0x26,</div><div class="line">                    (byte) 0x80, (byte) 0x00, (byte) 0x00, (byte) 0x00,</div><div class="line">                    (byte) 0x80, (byte) 0x00,</div><div class="line">                    (byte) 0x80, (byte) 0x00, (byte) 0x00, (byte) 0x00,</div><div class="line">                    (byte) 0x00, (byte) 0x00, (byte) 0x00, (byte) 0x00,</div><div class="line">                    (byte) 0x80, (byte) 0x00, (byte) 0x00, (byte) 0x00,</div><div class="line">                    (byte) 0x00, (byte) 0x08,  //bt add for phone, can be automate in the future</div><div class="line">                    (byte) 0x3C, (byte) 0x5A, (byte) 0x37, (byte) 0xFF,</div><div class="line">                    (byte) 0xFE, (byte) 0x95, (byte) 0xEE, (byte) 0xE3,</div><div class="line">                    (byte) 0x00, (byte) 0x00,</div><div class="line">                    (byte) 0x00, (byte) 0x00,</div><div class="line">                    (byte) 0x00, (byte) 0x00,</div><div class="line">                    (byte) 0x00, (byte) 0x00, (byte) 0x00, (byte) 0x00&#125;;</div><div class="line">//          Presentation APDU [0xE700]</div><div class="line">            final byte data_DR[] = new byte[]&#123;(byte) 0xE7, (byte) 0x00,</div><div class="line">                    (byte) 0x00, (byte) 0x12,</div><div class="line">                    (byte) 0x00, (byte) 0x10,</div><div class="line">                    (byte) invoke[0], (byte) invoke[1],</div><div class="line">                    (byte) 0x02, (byte) 0x01,</div><div class="line">                    (byte) 0x00, (byte) 0x0A,</div><div class="line">                    (byte) 0x00, (byte) 0x00,</div><div class="line">                    (byte) 0x00, (byte) 0x00, (byte) 0x00, (byte) 0x00,</div><div class="line">                    (byte) 0x0D, (byte) 0x1D,</div><div class="line">                    (byte) 0x00, (byte) 0x00&#125;;</div><div class="line"></div><div class="line">            final byte get_MDS[] = new byte[]&#123;(byte) 0xE7, (byte) 0x00,</div><div class="line">                    (byte) 0x00, (byte) 0x0E,</div><div class="line">                    (byte) 0x00, (byte) 0x0C,</div><div class="line">                    (byte) 0x00, (byte) 0x24,</div><div class="line">                    (byte) 0x01, (byte) 0x03,</div><div class="line">                    (byte) 0x00, (byte) 0x06,</div><div class="line">                    (byte) 0x00, (byte) 0x00,</div><div class="line">                    (byte) 0x00, (byte) 0x00,</div><div class="line">                    (byte) 0x00, (byte) 0x00&#125;;</div><div class="line"></div><div class="line">            final byte data_RR[] = new byte[]&#123;(byte) 0xE5, (byte) 0x00,</div><div class="line">                    (byte) 0x00, (byte) 0x02,</div><div class="line">                    (byte) 0x00, (byte) 0x00&#125;;</div><div class="line"></div><div class="line">            try &#123;</div><div class="line">                Log.i(TAG, String.valueOf(count));</div><div class="line">                if (count == 1) &#123;</div><div class="line">                    fos.write(data_AR);</div><div class="line">                    Log.i(TAG, &quot;Association Responsed!&quot;);</div><div class="line">                &#125; else if (count == 2) &#123;</div><div class="line">                    fos.write(get_MDS);</div><div class="line">                    Log.i(TAG, &quot;Get MDS object attributes!&quot;);</div><div class="line">//            		fos.write(data_ABORT);</div><div class="line">                &#125; else if (count == 3) &#123;</div><div class="line">                    fos.write(data_DR);</div><div class="line">                    Log.i(TAG, &quot;Data Responsed!&quot;);</div><div class="line">                &#125; else if (count == 4) &#123;</div><div class="line">                    fos.write(data_RR);</div><div class="line">                    Log.i(TAG, &quot;Data Released!&quot;);</div><div class="line">                &#125;</div><div class="line">            &#125; catch (IOException ioe) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>写线程的逻辑非常清晰，就是通过同一个ParcelFileDescriptor向血压计发送数据。发送的数据在这里已经写死，一共四组数据：作用依次是确认连接请求；确认收到测量数据；请求血压计的特征；确认断开连接。</p>
<p>大功告成，收到数据后界面如下：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1972331-dc9a150422a28ca0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Screenshot_2016-09-18-09-53-32.png"></p>
<p>第一次写文章，有各种不足之处，请大家指正。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/28/Android蓝牙健康设备开发：Health Device Profile(HDP)/" data-id="cj21y26ss00058zi3wwdp3k4d" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-seamcarving" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/27/seamcarving/" class="article-date">
  <time datetime="2017-03-27T03:25:17.000Z" itemprop="datePublished">2017-03-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/算法/">算法</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/27/seamcarving/">SeamCarving</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h2><p>第二周主要内容仍然是关于图的算法，主要内容为：</p>
<ul>
<li><p>最小生成树</p>
<ol>
<li><a href="http://algs4.cs.princeton.edu/43mst/KruskalMST.java.html" target="_blank" rel="external">Kruskal算法</a></li>
</ol>
<ul>
<li><a href="http://algs4.cs.princeton.edu/43mst/LazyPrimMST.java.html" target="_blank" rel="external">延时Prim算法</a></li>
<li><a href="http://algs4.cs.princeton.edu/43mst/PrimMST.java.html" target="_blank" rel="external">即时Prim算法</a></li>
</ul>
</li>
<li><p>最短路径</p>
<ol>
<li><a href="http://algs4.cs.princeton.edu/44sp/DijkstraSP.java.html" target="_blank" rel="external">Dijkstra算法</a>：适用无负权值边的图</li>
<li><a href="http://algs4.cs.princeton.edu/44sp/AcyclicSP.java.html" target="_blank" rel="external">DAG最短路径算法</a>：使用拓扑排序</li>
<li><a href="http://algs4.cs.princeton.edu/44sp/BellmanFordSP.java.html" target="_blank" rel="external">Bellman-Ford算法</a>：适用含负权值边的图</li>
</ol>
</li>
</ul>
<p>编程作业是SeamCarver：<a href="http://coursera.cs.princeton.edu/algs4/assignments/seamCarving.html" target="_blank" rel="external">原题地址</a></p>
<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><p>SeamCarving是一种调整图像尺寸的算法：从一幅图像中选出最不重要的像素并删去，在尽可能保留图像内容的情况下改变图像的尺寸。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1972331-660935e20fc9cffb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="original image"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1972331-af427579a68a1020.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="resized image"></p>
<p>上图就是SeamCarving算法的应用，原图尺寸为505-by-287，变换后的图片尺寸为355-by-287。虽然尺寸变了，但是没有发生拉伸扭曲，保留了原图的特征。</p>
<p>算法步骤：</p>
<ol>
<li>计算每个像素点的权重</li>
<li>找到水平（垂直）方向上的权重最小的像素序列，称为seam</li>
<li>移除seam</li>
</ol>
<p><img src="http://upload-images.jianshu.io/upload_images/1972331-fc4cdeee99bc9727.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="vertical seam"></p>
<p>备注：</p>
<ul>
<li>像素点的权重计算使用<code>dual-gradient energy function</code>,具体计算方法在原题中有。</li>
<li>从像素点<code>(i,j)</code>出发(假设垂直方向)只能连接到下一行的相邻三个像素<code>(i-1,j+1)</code>,<code>(i,j+1)</code>,<code>(i+1,j+1)</code></li>
<li>坐标系与默认的不同：<code>(i,j)</code>表示第<code>j</code>行，第<code>i</code>列<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">a 3-by-4 image</div><div class="line">  (0, 0)  	  (1, 0)  	  (2, 0)  </div><div class="line">  (0, 1)  	  (1, 1)  	  (2, 1)  </div><div class="line">  (0, 2)  	  (1, 2)  	  (2, 2)  </div><div class="line">  (0, 3)  	  (1, 3)  	  (2, 3)</div></pre></td></tr></table></figure>
</li>
</ul>
<p>API:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public class SeamCarver &#123;</div><div class="line">   public SeamCarver(Picture picture)                // create a seam carver object based on the given picture</div><div class="line">   public Picture picture()                          // current picture</div><div class="line">   public     int width()                            // width of current picture</div><div class="line">   public     int height()                           // height of current picture</div><div class="line">   public  double energy(int x, int y)               // energy of pixel at column x and row y</div><div class="line">   public   int[] findHorizontalSeam()               // sequence of indices for horizontal seam</div><div class="line">   public   int[] findVerticalSeam()                 // sequence of indices for vertical seam</div><div class="line">   public    void removeHorizontalSeam(int[] seam)   // remove horizontal seam from current picture</div><div class="line">   public    void removeVerticalSeam(int[] seam)     // remove vertical seam from current picture</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><ul>
<li>图像的表示使用alg4.jar中的Picture类。但是构造这个类的开销很大，在内部用一个二维数组作为类成员变量来表示图像中每个点，数组中存的值为此像素点<code>int</code>类型的rbg值。在实现算法的时候使用此二维数组，只在<code>public Picture picture()</code>方法中生成Picture对象并返回。</li>
<li><p>核心算法是找到某一方向上的seam，下面一步步思考：</p>
<ol>
<li>首先可以把图像抽象成一个有向图，顶点是每一个像素点，每个顶点有三条边指向下一行（列）的相邻顶点。</li>
<li>seam即是一条最短路径，权值就是最短路径上所有像素点的权重。</li>
<li>这是一个无环有向图（DAG），从时间复杂度考虑应该使用<strong>无环有向图的最短路径算法</strong>，而不是Dijkstra算法。</li>
<li>因此需要得到拓扑顺序，在这里不需要使用深度优先搜索来计算。<strong>以垂直方向为例，自上而下，每一行的拓扑顺序先于下一行，而每一行中各个顶点的顺序无关紧要</strong>。</li>
<li>因此在最短路径算法中，可以直接for循环自上而下遍历所有顶点，进行松弛（relax）操作。</li>
</ol>
</li>
<li><p>水平和垂直方向：两个不同方向的算法实质是一样的，只要先对表示图像的二维数组进行转置，就能够复用代码。<br>java中二维数组实际是由一维数组的每个元素表示其他各个一维数组，根据题意，垂直方向的像素作为第二层数组，方便用<code>System.arraycopy()</code>来整体移动，因此我们实现<code>removeHorizontalSeam(int[] seam)</code>方法：即水平方向上每行移除一个像素点，再整体移动剩余像素点；而对于<code>removeVerticalSeam(int[] seam)</code>方法，只要转置二维数组、调用<code>removeHorizontalSeam(int[] seam)</code>、再转置二维数组。</p>
</li>
</ul>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>成员变量：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">private int[][] colors;</div></pre></td></tr></table></figure></p>
<p>构造方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public Picture picture() &#123;</div><div class="line">        Picture picture = new Picture(colors.length, colors[0].length);</div><div class="line">        for (int i = 0; i &lt; colors.length; i++) &#123;</div><div class="line">            for (int j = 0; j &lt; colors[0].length; j++) &#123;</div><div class="line">                Color color = new Color(this.colors[i][j]);</div><div class="line">                picture.set(i, j, color);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return picture;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><code>width()</code>和<code>height()</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public int width() &#123;</div><div class="line">    return this.colors.length;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public int height() &#123;</div><div class="line">    return this.colors[0].length;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>energy()</code>：使用<code>dual-gradient energy function</code>来计算</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">public double energy(int x, int y) &#123;</div><div class="line">        if (x &lt; 0 || x &gt; this.width() - 1 || y &lt; 0 || y &gt; this.height() - 1) &#123;</div><div class="line">            throw new IndexOutOfBoundsException();</div><div class="line">        &#125;</div><div class="line">        if (x == 0 || x == this.width() - 1 || y == 0 || y == this.height() - 1) &#123;</div><div class="line">            return 1000.0;</div><div class="line">        &#125; else &#123;</div><div class="line">            int deltaXRed = red(colors[x - 1][y]) -</div><div class="line">                    red(colors[x + 1][y]);</div><div class="line">            int deltaXGreen = green(colors[x - 1][y]) -</div><div class="line">                    green(colors[x + 1][y]);</div><div class="line">            int deltaXBlue = blue(colors[x - 1][y]) -</div><div class="line">                    blue(colors[x + 1][y]);</div><div class="line"></div><div class="line">            int deltaYRed = red(colors[x][y - 1]) - red(colors[x][y + 1]);</div><div class="line">            int deltaYGreen = green(colors[x][y - 1]) - green(colors[x][y + 1]);</div><div class="line">            int deltaYBlue = blue(colors[x][y - 1]) - blue(colors[x][y + 1]);</div><div class="line"></div><div class="line">            return Math.sqrt(Math.pow(deltaXRed, 2) + Math.pow(deltaXBlue, 2) + Math.pow(deltaXGreen, 2) + Math.pow(deltaYRed, 2) + Math.pow(deltaYBlue, 2) + Math.pow(deltaYGreen, 2));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><code>findVerticalSeam()</code></p>
<ol>
<li>先计算所有顶点的distTo值，即从第一行到此顶点的最短路径上所有顶点权值之和</li>
<li>找出最后一行中distTo值最小的顶点，此顶点属于seam</li>
<li>根据nodeTo，逐行逆向找到每个属于seam的顶点</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">public int[] findVerticalSeam() &#123;</div><div class="line">        int n = this.width() * this.height();</div><div class="line">        int[] seam = new int[this.height()];</div><div class="line">        int[] nodeTo = new int[n];</div><div class="line">        double[] distTo = new double[n];</div><div class="line">        for (int i = 0; i &lt; n; i++) &#123;</div><div class="line">            if (i &lt; width())</div><div class="line">                distTo[i] = 0;</div><div class="line">            else</div><div class="line">                distTo[i] = Double.POSITIVE_INFINITY;</div><div class="line">        &#125;</div><div class="line">        for (int i = 0; i &lt; height(); i++) &#123;</div><div class="line">            for (int j = 0; j &lt; width(); j++) &#123;</div><div class="line">                for (int k = -1; k &lt;= 1; k++) &#123;</div><div class="line">                    if (j + k &lt; 0 || j + k &gt; this.width() - 1 || i + 1 &lt; 0 || i + 1 &gt; this.height() - 1) &#123;</div><div class="line">                        continue;</div><div class="line">                    &#125; else &#123;</div><div class="line">                        if (distTo[index(j + k, i + 1)] &gt; distTo[index(j, i)] + energy(j, i)) &#123;</div><div class="line">                            distTo[index(j + k, i + 1)] = distTo[index(j, i)] + energy(j, i);</div><div class="line">                            nodeTo[index(j + k, i + 1)] = index(j, i);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // find min dist in the last row</div><div class="line">        double min = Double.POSITIVE_INFINITY;</div><div class="line">        int index = -1;</div><div class="line">        for (int j = 0; j &lt; width(); j++) &#123;</div><div class="line">            if (distTo[j + width() * (height() - 1)] &lt; min) &#123;</div><div class="line">                index = j + width() * (height() - 1);</div><div class="line">                min = distTo[j + width() * (height() - 1)];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // find seam one by one</div><div class="line">        for (int j = 0; j &lt; height(); j++) &#123;</div><div class="line">            int y = height() - j - 1;</div><div class="line">            int x = index - y * width();</div><div class="line">            seam[height() - 1 - j] = x;</div><div class="line">            index = nodeTo[index];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return seam;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    private int index(int x, int y) &#123;</div><div class="line">        return width() * y + x;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>findHorizontalSeam()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public int[] findHorizontalSeam() &#123;</div><div class="line">        this.colors = transpose(this.colors);</div><div class="line">        int[] seam = findVerticalSeam();</div><div class="line">        this.colors = transpose(this.colors);</div><div class="line">        return seam;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>removeHorizontalSeam</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">public void removeHorizontalSeam(int[] seam) &#123;</div><div class="line">        if (height() &lt;= 1) throw new IllegalArgumentException();</div><div class="line">        if (seam == null) throw new NullPointerException();</div><div class="line">        if (seam.length != width()) throw new IllegalArgumentException();</div><div class="line"></div><div class="line">        for (int i = 0; i &lt; seam.length; i++) &#123;</div><div class="line">            if (seam[i] &lt; 0 || seam[i] &gt; height() - 1)</div><div class="line">                throw new IllegalArgumentException();</div><div class="line">            if (i &lt; width() - 1 &amp;&amp; Math.pow(seam[i] - seam[i + 1], 2) &gt; 1)</div><div class="line">                throw new IllegalArgumentException();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        int[][] updatedColor = new int[width()][height() - 1];</div><div class="line">        for (int i = 0; i &lt; seam.length; i++) &#123;</div><div class="line">            if (seam[i] == 0) &#123;</div><div class="line">                System.arraycopy(this.colors[i], seam[i] + 1, updatedColor[i], 0, height() - 1);</div><div class="line">            &#125; else if (seam[i] == height() - 1) &#123;</div><div class="line">                System.arraycopy(this.colors[i], 0, updatedColor[i], 0, height() - 1);</div><div class="line">            &#125; else &#123;</div><div class="line">                System.arraycopy(this.colors[i], 0, updatedColor[i], 0, seam[i]);</div><div class="line">                System.arraycopy(this.colors[i], seam[i] + 1, updatedColor[i], seam[i], height() - seam[i] - 1);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        this.colors = updatedColor;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>removeVerticalSeam:转置后复用removeHorizontalSeam(int[] seam)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public void removeVerticalSeam(int[] seam) &#123;</div><div class="line">        this.colors = transpose(this.colors);</div><div class="line">        removeHorizontalSeam(seam);</div><div class="line">        this.colors = transpose(this.colors);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>最后是转置方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">private int[][] transpose(int[][] origin) &#123;</div><div class="line">        if (origin == null) throw new NullPointerException();</div><div class="line">        if (origin.length &lt; 1) throw new IllegalArgumentException();</div><div class="line">        int[][] result = new int[origin[0].length][origin.length];</div><div class="line">        for (int i = 0; i &lt; origin[0].length; i++) &#123;</div><div class="line">            for (int j = 0; j &lt; origin.length; j++) &#123;</div><div class="line">                result[i][j] = origin[j][i];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return result;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="成绩"><a href="#成绩" class="headerlink" title="成绩"></a>成绩</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">ASSESSMENT SUMMARY</div><div class="line"></div><div class="line">Compilation:  PASSED</div><div class="line">API:          PASSED</div><div class="line"></div><div class="line">Findbugs:     PASSED</div><div class="line">Checkstyle:   FAILED (3 warnings)</div><div class="line"></div><div class="line">Correctness:  31/31 tests passed</div><div class="line">Memory:       7/7 tests passed</div><div class="line">Timing:       6/6 tests passed</div><div class="line"></div><div class="line">Aggregate score: 100.00%</div><div class="line">[Compilation: 5%, API: 5%, Findbugs: 0%, Checkstyle: 0%, Correctness: 60%, Memory: 10%, Timing: 20%]</div></pre></td></tr></table></figure>
<p>完整代码和测试用例在GitHub上，欢迎讨论<br><code>https://github.com/michael0905/SeamCarver</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/27/seamcarving/" data-id="cj21y26sq00048zi3oic5d7ft" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-wordnet" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/27/wordnet/" class="article-date">
  <time datetime="2017-03-27T03:25:16.000Z" itemprop="datePublished">2017-03-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/算法/">算法</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/27/wordnet/">WordNet</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近在coursera上学习Princeton大学的Algorithm PartII，这个系列的两门课是我见过最好的算法课。主讲Robert Sedgewick师承高德纳，声名远播，虽然年纪大了，但是讲课思路清晰，深入浅出。与Kevin Wayne共同编著的《算法》第四版作为教材，没有《算法导论》那么偏理论、晦涩难懂，能够把常见的数据结构和算法讲得很透彻，容易理解。<br>更值得称道的是这门课编程作业及其评分系统。上课的内容是基础的数据结构和算法，但编程作业往往是这些算法的实际应用，能真正理解为什么在给定的情况下要使用这样的数据结构、算法。作业的评分不仅仅是看正确与否，还有运行时间、内存的要求，会给出详细的分析报告，如果不是ACM大神，这些作业都值得花时间去仔细琢磨。<br>下面进入正题，第一周的作业WordNet</p>
<p>##题目<br>WordNet is a semantic lexicon for theEnglish language that is used extensively by computational linguistsand cognitive scientists; for example, it was a key component in IBM’sWatson.WordNet groups words into sets of synonyms called synsets and describes semantic relationships between them.One such relationship is the is-a relationship, which connects a hyponym(more specific synset) to a hypernym (more general synset).For example, locomotion is a hypernym of runningand running is a hypernym of dash.</p>
<p>The WordNet digraph.Your first task is to build the wordnet digraph: each vertex v is an integer that represents a synset, and each directed edge v→w represents that w is a hypernym of v.The wordnet digraph is a rooted DAG: it is acylic and has one vertex thatis an ancestor of every other vertex.However, it is not necessarily a tree because a synset can have more than onehypernym. A small subgraph of the wordnet digraph is illustrated below.</p>
<p>The WordNet input file formats.We now describe the two data files that you will use to create the wordnet digraph.The files are in CSV format: each line contains a sequence of fields,separated by commas.</p>
<p>List of noun synsets.The file synsets.txtlists all the (noun) synsets in WordNet.The first field is the synset id (an integer),the second field is the synonym set (or synset), and thethird field is its dictionary definition (or gloss).For example, the line<br>36,AND_circuit AND_gate,a circuit in a computer that fires only when all of its inputs fire<br>means that the synset { AND_circuit, AND_gate }has an id number of 36 and it’s gloss isa circuit in a computer that fires only when all of its inputs fire.The individual nouns that comprise a synset are separatedby spaces (and a synset element is not permitted to contain a space).The S synset ids are numbered 0 through S − 1;the id numbers will appear consecutively in the synset file.<br>List of hypernyms.The file hypernyms.txtcontains the hypernym relationships:The first field is a synset id; subsequent fields are the id numbersof the synset’s hypernyms. For example, the following line<br>164,21012,56099<br>means that the the synset 164 (“Actifed”) has two hypernyms:21012 (“antihistamine”) and56099 (“nasal_decongestant”),representing that Actifed is both an antihistamine and a nasal decongestant.The synsets are obtained from the corresponding lines in the file synsets.txt.</p>
<p>164,Actifed,trade name for a drug containing an antihistamine and a decongestant…<br>21012,antihistamine,a medicine used to treat allergies…<br>56099,nasal_decongestant,a decongestant that provides temporary relief of nasal…<br>WordNet data type.Implement an immutable data type WordNet with the following API:</p>
<p>// constructor takes the name of the two input files<br>public WordNet(String synsets, String hypernyms)</p>
<p>// the set of nouns (no duplicates), returned as an Iterable<br>public Iterable<string> nouns()</string></p>
<p>// is the word a WordNet noun?<br>public boolean isNoun(String word)</p>
<p>// distance between nounA and nounB (defined below)<br>public int distance(String nounA, String nounB)</p>
<p>// a synset (second field of synsets.txt) that is the common ancestor of nounA and nounB<br>// in a shortest ancestral path (defined below)<br>public String sap(String nounA, String nounB)</p>
<p>// for unit testing of this class<br>public static void main(String[] args)<br>The constructor should throw a java.lang.IllegalArgumentExceptionif the input does not correspond to a rooted DAG.The distance() and sap() methodsshould throw a java.lang.IllegalArgumentExceptionunless both of the noun arguments are WordNet nouns.<br>Your data type should use space linear in the input size(size of synsets and hypernyms files).The constructor should take time linearithmic (or better) in the input size.The method isNoun() should run in time logarithmic (or better) inthe number of nouns.The methods distance() and sap() should run in time linear in thesize of the WordNet digraph.</p>
<p>Shortest ancestral path.An ancestral path between two verticesv and w in a digraph is a directed path fromv to a common ancestor x, together witha directed path from w to the same ancestor x. A shortest ancestral path is an ancestral path of minimum total length.For example, in the digraph at left(digraph1.txt),the shortest ancestral path between3 and 11 has length 4 (with common ancestor 1).In the digraph at right (digraph2.txt),one ancestral path between 1 and 5 has length 4(with common ancestor 5), but the shortest ancestral path has length 2(with common ancestor 0).</p>
<p>SAP data type.Implement an immutable data type SAP with the following API:</p>
<p>// constructor takes a digraph (not necessarily a DAG)<br>public SAP(Digraph G)</p>
<p>// length of shortest ancestral path between v and w; -1 if no such path<br>public int length(int v, int w)</p>
<p>// a common ancestor of v and w that participates in a shortest ancestral path; -1 if no such path<br>public int ancestor(int v, int w)</p>
<p>// length of shortest ancestral path between any vertex in v and any vertex in w; -1 if no such path<br>public int length(Iterable<integer> v, Iterable<integer> w)</integer></integer></p>
<p>// a common ancestor that participates in shortest ancestral path; -1 if no such path<br>public int ancestor(Iterable<integer> v, Iterable<integer> w)</integer></integer></p>
<p>// for unit testing of this class (such as the one below)<br>public static void main(String[] args)<br>All methods should throw a java.lang.IndexOutOfBoundsException if one (or more) of the input arguments is not between 0 and G.V() - 1.You may assume that the iterable arguments contain at least one integer.All methods (and the constructor) should take time at mostproportional to E + Vin the worst case, where E and V are the number of edges and verticesin the digraph, respectively.Your data type should use space proportional to E + V.<br>Test client.The following test client takes the name of a digraph input file asas a command-line argument, constructs the digraph,reads in vertex pairs from standard input,and prints out the length of the shortest ancestral path between the two verticesand a common ancestor that participates in that path:</p>
<p>public static void main(String[] args) {<br>    In in = new In(args[0]);<br>    Digraph G = new Digraph(in);<br>    SAP sap = new SAP(G);<br>    while (!StdIn.isEmpty()) {<br>        int v = StdIn.readInt();<br>        int w = StdIn.readInt();<br>        int length   = sap.length(v, w);<br>        int ancestor = sap.ancestor(v, w);<br>        StdOut.printf(“length = %d, ancestor = %d\n”, length, ancestor);<br>    }<br>}<br>Here is a sample execution:<br>% more digraph1.txt             % java SAP digraph1.txt<br>13                              3 11<br>11                              length = 4, ancestor = 1<br> 7  3<br> 8  3                           9 12<br> 3  1                           length = 3, ancestor = 5<br> 4  1<br> 5  1                           7 2<br> 9  5                           length = 4, ancestor = 0<br>10  5<br>11 10                           1 6<br>12 10                           length = -1, ancestor = -1<br> 1  0<br> 2  0<br>Measuring the semantic relatedness of two nouns.Semantic relatedness refers to the degree to which two concepts are related. Measuring semantic relatedness is a challenging problem. For example, most of us agree that George Bush and John Kennedy (two U.S. presidents)are more related than are George Bushand chimpanzee (two primates). However, not most of us agree that George Bush and Eric Arthur Blair are related concepts. But if one is aware that George Bush and Eric Arthur Blair (aka George Orwell) are both communicators, then it becomes clear that the two concepts might be related.</p>
<p>We define the semantic relatednessof two wordnet nouns A and B as follows:</p>
<p>distance(A, B) = distance is the minimum length of any ancestral path betweenany synset v of A and any synset w of B.<br>This is the notion of distance that you will use to implement thedistance() and sap() methods in the WordNet data type.</p>
<p>Outcast detection.Given a list of wordnet nouns A1, A2,…, An, which nounis the least related to the others? To identify an outcast,compute the sum of the distances between each noun and every other one:</p>
<p>di   =  dist(Ai, A1)   +  dist(Ai, A2)   +   …   +   dist(Ai, An)<br>and return a noun Atfor which dt is maximum.<br>Implement an immutable data type Outcast with the following API:</p>
<p>// constructor takes a WordNet object<br>public Outcast(WordNet wordnet)</p>
<p>// given an array of WordNet nouns, return an outcast<br>public String outcast(String[] nouns)</p>
<p>// for unit testing of this class (such as the one below)<br>public static void main(String[] args)<br>Assume that argument array to the outcast() methodcontains only valid wordnet nouns (and that it contains at least two such nouns).<br>The following test client takes from the command line the name of a synset file, the name of a hypernym file, followed by thenames of outcast files, and prints out an outcast in each file:</p>
<p>public static void main(String[] args) {<br>    WordNet wordnet = new WordNet(args[0], args[1]);<br>    Outcast outcast = new Outcast(wordnet);<br>    for (int t = 2; t &lt; args.length; t++) {<br>        In in = new In(args[t]);<br>        String[] nouns = in.readAllStrings();<br>        StdOut.println(args[t] + “: “ + outcast.outcast(nouns));<br>    }<br>}<br>Here is a sample execution:<br>% more outcast5.txt<br>horse zebra cat bear table</p>
<p>% more outcast8.txt<br>water soda bed orange_juice milk apple_juice tea coffee</p>
<p>% more outcast11.txt<br>apple pear peach banana lime lemon blueberry strawberry mango watermelon potato</p>
<p>% java Outcast synsets.txt hypernyms.txt outcast5.txt outcast8.txt outcast11.txt<br>outcast5.txt: table<br>outcast8.txt: bed<br>outcast11.txt: potato</p>
<p>##题目分析<br>wordnet是一个有上下位关系的英语词典，可以描述词语间的关系。下位词是上位词的一种具体描述，是一种isa关系。例如running是dash的上位词。从数据结构上来看wordnet是一个有向无环图。每个节点是一个同义词集合（synset），一个英语单词或复合词可能有多个意思，因此可能会出现在多个不同节点中。每条边都是由下位词指向上位词，有且仅有从下位词到上位词的路径，因此不可能存在环。<br>题目中wordnet是以synsets.txt和hypernyms.txt的形式给出。synsets.txt中按字母顺序给出了所有同义词集合的序号、集合、描述。hypernyms.txt按同义词集合的序号给出了上下位的关系，每行第一个序号是下位词，之后的序号都是上位词。一个下位词可能存在多个上位词。<br>题目的要求是实现三个类：</p>
<ul>
<li>WordNet.java</li>
<li>SAP.java</li>
<li>Outcast.java</li>
</ul>
<p>SAP.java是一个基础类，给定一个有向图，计算两点之间的最短距离，以及两点的共同祖先。首先应该完成这个类。<br>WordNet.java中实现计算wordnet结构中两个词的最短距离及共同祖先。<br>Outcast.java就比较简单了，找出一组词中最不相关的一个，调用WordNet.java很容易实现。</p>
<p>##SAP.java<br>下面具体分析每个类的实现<br>首先实现SAP.java，在这个类中实现计算最短距离和共同祖先的算法，然后可以应用到wordnet中。</p>
<p>###分析<br>求最短路径和共同祖先的思想就是从两个不同节点出发，找到都能到达且距离最短的节点。要计算距离，使用广度优先搜索，并且保存和更新每个节点的到出发点的距离。</p>
<p>成员变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">private Digraph digraph;</div><div class="line"></div><div class="line">private int ancestor;</div><div class="line">    </div><div class="line">private int length;</div></pre></td></tr></table></figure>
<p>构造方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public SAP(Digraph G) &#123;</div><div class="line">       if (G == null) throw new NullPointerException();</div><div class="line">       this.digraph = G;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>由于最短距离是两个节点到某公共节点的距离组合，可能出现多种情况，因此自定义一个数据结构Node来表示公共节点，把所有可能的公共节点放入一个优先队列中，最后从中取最小值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">private class Node implements Comparable&lt;Node&gt; &#123;</div><div class="line">        private int length;</div><div class="line">        private int id;</div><div class="line"></div><div class="line">        Node(int length, int id) &#123;</div><div class="line">            this.length = length;</div><div class="line">            this.id = id;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public int compareTo(Node o) &#123;</div><div class="line">            if (length &gt; o.length) &#123;</div><div class="line">                return 1;</div><div class="line">            &#125; else if (length == o.length) &#123;</div><div class="line">                return 0;</div><div class="line">            &#125; else &#123;</div><div class="line">                return -1;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">```   </div><div class="line">求最短距离的完整代码：</div><div class="line"></div><div class="line">1. 先对一个节点进行广度优先搜素，计算到所有节点的距离。</div><div class="line">2. 对另一个节点进行广度优先搜素，计算到所有节点的距离，如果某节点可以从两个节点分别到达，则存在优先队列中。</div><div class="line">3. 从优先队列中取出最小值，即为最短距离。</div></pre></td></tr></table></figure>
<p>// length of shortest ancestral path between v and w; -1 if no such path<br>    public int length(int v, int w) {<br>        if (v &lt; 0 || v &gt;= digraph.V() || w &lt; 0 || w &gt;= digraph.V())<br>            throw new IndexOutOfBoundsException();<br>        MinPQ<node> possibleLength = new MinPQ();<br>        boolean[] marked = new boolean[this.digraph.V()];<br>        marked[v] = true;<br>        int[] pathV = new int[digraph.V()];<br>        int[] pathW = new int[digraph.V()];<br>        for (int i = 0; i &lt; digraph.V(); i++) {<br>            pathV[i] = -1;<br>            pathW[i] = -1;<br>        }<br>        pathV[v] = 0;<br>        pathW[w] = 0;</node></p>
<pre><code>    // bfs on v
    Queue&lt;Integer&gt; queue = new Queue&lt;&gt;();
    queue.enqueue(v);
    while (!queue.isEmpty()) {
        int vertex = queue.dequeue();
        for (int nextVertex : digraph.adj(vertex)) {
            if (!marked[nextVertex]) {
                marked[nextVertex] = true;
                queue.enqueue(nextVertex);
                if (pathV[nextVertex] == -1 || pathV[nextVertex] &gt; pathV[vertex] + 1) {
                    pathV[nextVertex] = pathV[vertex] + 1;
                }

            }
        }
    }

    // bfs on w
    marked = new boolean[this.digraph.V()];
    marked[w] = true;
    queue.enqueue(w);
    while (!queue.isEmpty()) {
        int vertex = queue.dequeue();
        if (pathV[vertex] &gt; -1) {
            Node node = new Node(pathV[vertex] + pathW[vertex], vertex);
            possibleLength.insert(node);
        }
        for (int nextVertex : digraph.adj(vertex)) {
            if (!marked[nextVertex]) {
                marked[nextVertex] = true;
                queue.enqueue(nextVertex);
                if (pathW[nextVertex] == -1 || pathW[nextVertex] &gt; pathW[vertex] + 1) {
                    pathW[nextVertex] = pathW[vertex] + 1;
                }

            }
        }
    }
    if (possibleLength.size() &gt; 0) {
        Node node = possibleLength.delMin();
        this.length = node.length;
        this.ancestor = node.id;
    } else {
        this.length = -1;
        this.ancestor = -1;
    }
    return this.length;
}
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">共同祖先在计算最短距离时也能获得，Node中的id就是共同祖先，因此可以复用。</div></pre></td></tr></table></figure>
<p>// a common ancestor of v and w that participates in a shortest ancestral path; -1 if no such path<br>    public int ancestor(int v, int w) {<br>        length(v, w);<br>        return this.ancestor;<br>    }<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">输入的v,w为多个节点时，直接用暴力for循环找出每两个节点间的最短距离和共同祖先，存到优先队列中，最后取出的就是两组节点间的最短纪录和共同祖先。</div><div class="line">代码：</div></pre></td></tr></table></figure></p>
<pre><code>// length of shortest ancestral path between any vertex in v and any vertex in w; -1 if no such path
public int length(Iterable&lt;Integer&gt; v, Iterable&lt;Integer&gt; w) {
    if (v == null || w == null) throw new NullPointerException();
    MinPQ&lt;Node&gt; possibleNodes = new MinPQ();
    for (int nodeV : v) {
        if (nodeV &lt; 0 || nodeV &gt; this.digraph.V())
            throw new IndexOutOfBoundsException();
        for (int nodeW : w) {
            if (nodeW &lt; 0 || nodeW &gt; this.digraph.V())
                throw new IndexOutOfBoundsException();

            Node node = new Node(length(nodeV, nodeW), ancestor(nodeV, nodeW));
            possibleNodes.insert(node);
        }
    }

    if (possibleNodes.size() &gt; 0) {
        Node node = possibleNodes.delMin();
        this.length = node.length;
        this.ancestor = node.id;
    } else {
        this.length = -1;
        this.ancestor = -1;
    }
    return this.length;
}

// a common ancestor that participates in shortest ancestral path; -1 if no such path
public int ancestor(Iterable&lt;Integer&gt; v, Iterable&lt;Integer&gt; w) {
    length(v, w);
    return this.ancestor;
}
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">## WordNet.java</div><div class="line">要把sap中的算法实际高效地应用到wordnet中并不简单，需要找到适合的数据结构来储存我们需要的信息并且能够高效地查询。</div><div class="line"></div><div class="line">题目要求</div><div class="line"></div><div class="line">1. 返回wordnet中所有的词</div><div class="line">2. 判断一个词是否在wordnet中</div><div class="line">3. 两个词的最短距离</div><div class="line">4. 两个词最短路径上的共同上位词的同义词集合</div><div class="line"></div><div class="line"></div><div class="line">要做到1和2两个要求，需要一个没有重复词的集合，而且能够根据词来快速搜索。提到快速搜索，立即想到时间复杂度log(n)的二叉搜索树，正好符合题目的时间要求。因此，使用PartI中讲到过的SET&lt;key&gt;(在Alg4.jar中，用平衡二叉树实现log(n)的插入、搜索)。</div><div class="line"></div><div class="line">SET需要一个key来实现搜索。要求搜索的是词，但不能直接以string作为key，因为还要考虑到最短路径的实现。因此，用一个自定义结构：实现Comparable接口时比较的是词的字母顺序，另外由于词的多义性用一个ArrayList存放出现在wordnet中的可能位置。</div></pre></td></tr></table></figure>
<p>private class Node implements Comparable<node> {<br>        private ArrayList<integer> ids;<br>        private String noun;<br>        Node(String noun) {<br>            this.noun = noun;<br>            this.ids = new ArrayList&lt;&gt;();<br>        }</integer></node></p>
<pre><code>    private void addId(int id) {
        this.ids.add(id);
    }

    private ArrayList&lt;Integer&gt; getIds() {
        return this.ids;
    }

    @Override
    public int compareTo(Node o) {
        return this.noun.compareTo(o.noun);
    }
}
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">成员变量：</div></pre></td></tr></table></figure>
<p>private SAP wordnetSap;<br>    private Digraph digraph;<br>    private boolean hasCycle;<br>    private boolean[] onStack;<br>    private boolean[] marked;<br>    private ArrayList<integer> possibleRoots; // a DAG has only one root<br>    private ArrayList<string[]> synsets; // synsets for each wordnet node<br>    private SET<node> allNouns; // SET to store Node<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">构造方法：读取synsets.txt和hypernyms.txt,构建表示wordnet的图。Node表示词以及词可能出现的位置，建立SET。与sap中不同，共同祖先需要根据序号返回同义词组，与SET的思路不一致，因此还需要一个ArrayList来表示每个序号对应的同义词组。</div><div class="line"></div><div class="line">根据题目要求，还需要检查构建的wordnet图是否合法，即检查是否无环、是否只有一个root。这个检查合法性同样用广度优先搜索可以完成：</div><div class="line"></div><div class="line">* 是否无环：搜索时如果之前访问过某节点，则构成环。</div><div class="line">* 是否只有一个root：无论从哪个节点开始搜索，最后一个节点（没有指向其他节点的边）是唯一的。</div></pre></td></tr></table></figure></node></string[]></integer></p>
<p>public WordNet(String synsets, String hypernyms) {<br>        if (synsets == null || hypernyms == null)<br>            throw new NullPointerException();<br>        possibleRoots = new ArrayList&lt;&gt;();<br>        this.synsets = new ArrayList&lt;&gt;();<br>        allNouns = new SET<node>();<br>        int count = 0;<br>        try {<br>            BufferedReader in = new BufferedReader(new FileReader(synsets));<br>            String line;<br>            while ((line = in.readLine()) != null) {<br>                String[] parts = line.split(“,”);<br>                String aSynset = parts[1];<br>                String[] strings = aSynset.split(“ “);<br>                for (String str : strings) {<br>                    Node node = new Node(str);<br>                    if (this.allNouns.contains(node)) {<br>                        this.allNouns.ceiling(node).addId(Integer.parseInt(parts[0]));<br>                    }else {<br>                        node.addId(Integer.parseInt(parts[0]));<br>                        this.allNouns.add(node);<br>                    }<br>                }<br>                this.synsets.add(strings);</node></p>
<pre><code>            count++;
        }
        in.close();

        this.digraph = new Digraph(count);

        BufferedReader hypernymsReader = new BufferedReader(new FileReader(hypernyms));
        while ((line = hypernymsReader.readLine()) != null){
            String[] temp = line.split(&quot;,&quot;);
            int id = Integer.parseInt(temp[0]);
            for (int i = 1; i &lt; temp.length; i++) {
                this.digraph.addEdge(id, Integer.parseInt(temp[i]));
            }
        }
        hypernymsReader.close();
    } catch (IOException e) {
        e.printStackTrace();
    }

    this.wordnetSap = new SAP(this.digraph);

    onStack = new boolean[digraph.V()];
    marked = new boolean[digraph.V()];
    if (hasCycle(this.digraph)) throw new IllegalArgumentException();
    if (this.possibleRoots.size() &gt; 1) throw new IllegalArgumentException();
}

private boolean hasCycle(Digraph digraph) {
    for (int i = 0; i &lt; digraph.V(); i++) {
        if (!this.marked[i]) dfs(digraph, i);
    }
    return hasCycle;
}

private void dfs(Digraph digraph, int v) {

    onStack[v] = true;
    marked[v] = true;

    if (!digraph.adj(v).iterator().hasNext()) {
        if (!this.possibleRoots.contains(v))
            this.possibleRoots.add(v);
    }
    for (int w : digraph.adj(v)) {
        if (this.hasCycle) return;
        else if (!marked[w]) {
            dfs(digraph, w);
        }
        else if (onStack[w]) this.hasCycle = true;
    }
    onStack[v] = false;
}
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">选对了合适的数据结构，完成了构造方法，其实就完成了绝大部分工作，剩下的实现就相对容易了。</div><div class="line"></div><div class="line">返回wordnet中所有的词：</div></pre></td></tr></table></figure>
<p>public Iterable<string> nouns() {<br>        ArrayList<string> nouns = new ArrayList&lt;&gt;();<br>        for (Node node : this.allNouns) {<br>            nouns.add(node.noun);<br>        }<br>        return nouns;<br>    }<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">判断一个词是否在wordnet中：</div></pre></td></tr></table></figure></string></string></p>
<p>public boolean isNoun(String word) {<br>        if (word == null) throw new NullPointerException();<br>        Node node = new Node(word);<br>        return this.allNouns.contains(node);<br>    }<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">两个词的最短距离：用SET和Node迅速找到词所对应的可能位置，用sap中的方法可以马上计算。</div></pre></td></tr></table></figure></p>
<p>public int distance(String nounA, String nounB) {<br>        if (nounA == null || nounB == null)<br>            throw new NullPointerException();<br>        if (!isNoun(nounA) || !isNoun(nounB))<br>            throw new IllegalArgumentException();<br>        ArrayList<integer> idAs;<br>        ArrayList<integer> idBs;</integer></integer></p>
<pre><code>    Node nodeA = new Node(nounA);
    Node nodeB = new Node(nounB);
    nodeA = this.allNouns.ceiling(nodeA);
    nodeB = this.allNouns.ceiling(nodeB);
    idAs = nodeA.getIds();
    idBs = nodeB.getIds();

    return wordnetSap.length(idAs, idBs);
}
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">两个词最短路径上的共同上位词的同义词集合：同样用sap中的方法找到位置，然后从事先存好的arraylist中获取同义词集合，拼接成给定的形式。</div></pre></td></tr></table></figure>
<p>public String sap(String nounA, String nounB) {<br>        if (nounA == null || nounB == null)<br>            throw new NullPointerException();<br>        if (!isNoun(nounA) || !isNoun(nounB))<br>            throw new IllegalArgumentException();</p>
<pre><code>    ArrayList&lt;Integer&gt; idAs;
    ArrayList&lt;Integer&gt; idBs;

    Node nodeA = new Node(nounA);
    Node nodeB = new Node(nounB);
    nodeA = this.allNouns.ceiling(nodeA);
    nodeB = this.allNouns.ceiling(nodeB);
    idAs = nodeA.getIds();
    idBs = nodeB.getIds();

    int id = wordnetSap.ancestor(idAs, idBs);
    String[] strings = this.synsets.get(id);
    String result = &quot;&quot;;
    for (int i = 0; i&lt; strings.length; i++) {
        result += strings[i];
        if (i != strings.length - 1)
            result += &quot; &quot;;
    }
    return result;
}
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">## Outcast.java</div><div class="line"></div><div class="line">outcast就简单了，从给定的词组中，计算每个词与其他词的最短距离之和。和最大的词自然就是与别的词最不同的了。</div></pre></td></tr></table></figure>
<p>public class Outcast {<br>    private WordNet wordNet;</p>
<pre><code>public Outcast(WordNet wordnet) {
    this.wordNet = wordnet;
}

public String outcast(String[] nouns) {
    int[] distances = new int[nouns.length];
    for (int i = 0; i &lt; nouns.length; i++) {
        String noun = nouns[i];
        for (int j = 0; j &lt; nouns.length; j++) {
            if (i != j) {
                distances[i] += wordNet.distance(noun, nouns[j]);
            }
        }
    }
    int max = 0;
    int id = 0;
    for (int i = 0; i &lt; distances.length; i++) {
        if (distances[i] &gt; max) {
            max = distances[i];
            id = i;
        }
    }

    return nouns[id];
}
</code></pre><p>}<br>```</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>笔者水平有限，上述答案其实只有91分，运行时间不达标。抛砖引玉，希望大神们能够提出改进方法，大家一起学习进步，谢谢！</p>
<p>项目源码在GitHub中，请点<a href="https://github.com/michael0905/WordNet" target="_blank" rel="external">这里</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/27/wordnet/" data-id="cj21y26st00078zi30mzf2d4j" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Catégories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS开发/">iOS开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/自然语言处理/">自然语言处理</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Articles récents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/04/28/python文本相似度计算/">python文本相似度计算</a>
          </li>
        
          <li>
            <a href="/2017/03/28/CoreBluetooth连接蓝牙健康设备/">CoreBluetooth连接蓝牙健康设备</a>
          </li>
        
          <li>
            <a href="/2017/03/28/AFNetworking 3.x 使用心得/">WordNet</a>
          </li>
        
          <li>
            <a href="/2017/03/28/Android蓝牙健康设备开发：Health Device Profile(HDP)/">Android蓝牙健康设备开发：Health Device Profile(HDP)</a>
          </li>
        
          <li>
            <a href="/2017/03/27/seamcarving/">SeamCarving</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Yiyuan Liu<br>
      Propulsé by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>