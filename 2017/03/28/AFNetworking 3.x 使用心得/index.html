<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>WordNet | Yiyuan Liu&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="AFNetworking毫无疑问是目前iOS开发中（Objective-C）最好的第三方网络库。一般规模的app使用AFNetworking就可以完成所有需求，不需要自己造轮子。在使用AFNetworking的过程中遇到了许多坑，也获得了不少经验，在这里总结一下，希望能够帮助到大家。
##AFNetworking进一步封装AFNetworking 3.x 已经为我们提供了丰富而且易用的API，但还">
<meta property="og:type" content="article">
<meta property="og:title" content="WordNet">
<meta property="og:url" content="http://yoursite.com/2017/03/28/AFNetworking 3.x 使用心得/index.html">
<meta property="og:site_name" content="Yiyuan Liu's Blog">
<meta property="og:description" content="AFNetworking毫无疑问是目前iOS开发中（Objective-C）最好的第三方网络库。一般规模的app使用AFNetworking就可以完成所有需求，不需要自己造轮子。在使用AFNetworking的过程中遇到了许多坑，也获得了不少经验，在这里总结一下，希望能够帮助到大家。
##AFNetworking进一步封装AFNetworking 3.x 已经为我们提供了丰富而且易用的API，但还">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1972331-39e2e19c7040a3b9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2017-03-28T07:59:36.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WordNet">
<meta name="twitter:description" content="AFNetworking毫无疑问是目前iOS开发中（Objective-C）最好的第三方网络库。一般规模的app使用AFNetworking就可以完成所有需求，不需要自己造轮子。在使用AFNetworking的过程中遇到了许多坑，也获得了不少经验，在这里总结一下，希望能够帮助到大家。
##AFNetworking进一步封装AFNetworking 3.x 已经为我们提供了丰富而且易用的API，但还">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/1972331-39e2e19c7040a3b9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
  
    <link rel="alternate" href="/atom.xml" title="Yiyuan Liu&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Yiyuan Liu&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-AFNetworking 3.x 使用心得" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/28/AFNetworking 3.x 使用心得/" class="article-date">
  <time datetime="2017-03-28T07:59:36.000Z" itemprop="datePublished">2017-03-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS开发/">iOS开发</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      WordNet
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>AFNetworking毫无疑问是目前iOS开发中（Objective-C）最好的第三方网络库。一般规模的app使用AFNetworking就可以完成所有需求，不需要自己造轮子。<br>在使用AFNetworking的过程中遇到了许多坑，也获得了不少经验，在这里总结一下，希望能够帮助到大家。</p>
<p>##AFNetworking进一步封装<br>AFNetworking 3.x 已经为我们提供了丰富而且易用的API，但还是不够。AFNetworking是一个通用的库，而在我们自己的项目中，有特定的需求，而且往往在许多类中都需要用到网络请求。对AFNetworking进一步封装，能够大大简化代码，减少重复。<br>举个例子，新建一个CDMNetworkManager类，继承AFHTTPSessionManager。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">//CDMNetworkManager.h</div><div class="line">#import &lt;AFNetworking/AFNetworking.h&gt;</div><div class="line"></div><div class="line">typedef void(^requestSuccessBlock) (NSURLSessionTask *task, id resposeObject);</div><div class="line">typedef void(^requestFailureBlock) (NSURLSessionTask *task, NSError *error);</div><div class="line"></div><div class="line">@interface CDMNetworkManager : AFHTTPSessionManager</div><div class="line">+(instancetype)sharedManager;</div><div class="line">-(void)sendPostRequest:(NSString *)path parameters:(NSDictionary *)parameters success:(requestSuccessBlock)success failure:(requestFailureBlock)failure;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">//CDMNetworkManager.m</div><div class="line">#import &quot;CDMNetworkManager.h&quot;</div><div class="line"></div><div class="line">typedef void(^requestSuccessBlock) (NSURLSessionTask *task, id resposeObject);</div><div class="line">typedef void(^requestFailureBlock) (NSURLSessionTask *task, NSError *error);</div><div class="line"></div><div class="line">@implementation CDMNetworkManager</div><div class="line"></div><div class="line">+(instancetype)sharedManager&#123;</div><div class="line">    static CDMNetworkManager *manager = nil;</div><div class="line">    </div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">       manager = [[self alloc] initWithBaseURL:[NSURL URLWithString:@&quot;http://www.someurl.com/&quot;]];</div><div class="line"></div><div class="line">    &#125;);</div><div class="line">    return manager;</div><div class="line">&#125;</div><div class="line"></div><div class="line">-(void)sendPostRequest:(NSString *)path parameters:(NSDictionary *)parameters success:(requestSuccessBlock)success failure:(requestFailureBlock)failure&#123;</div><div class="line">    [self POST:path parameters:parameters progress:nil success:^(NSURLSessionTask *task, id responseObject)&#123;</div><div class="line">        success(task,responseObject);</div><div class="line">    &#125; failure:^(NSURLSessionTask *task, NSError *error)&#123;</div><div class="line">        failure(task,error);</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>初始化方法中使用了单例模式，这样与服务器的连接不会断掉，省去了每次建立连接时三次握手等过程。如果有多个URL地址，可以创建多个单例。如果有更多特殊的要求，比如设置超时时间等，可以在这个方法中设置。<br>具体的网络请求方法这里只封装了一个简单的post方法，如果有需要可以封装别的方法。<br>调用的时候很简单，在任何一个需要发送post请求的类中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[[CDMNetworkManager sharedManager] sendPostRequest:@&quot;XXX&quot; parameters:parameter success:^(NSURLSessionTask *task, id responseObject)&#123;</div><div class="line">        //your code</div><div class="line">    &#125; failure:^(NSURLSessionTask *task, NSError *error)&#123;</div><div class="line">        // your code</div><div class="line">    &#125;];</div></pre></td></tr></table></figure></p>
<h2 id="调试工具"><a href="#调试工具" class="headerlink" title="调试工具"></a>调试工具</h2><p>曾经我每次网络请求调试的时候只会在回调里写log，然后在控制台里一行一行的仔细查找。如果这个请求返回的内容很多，在Xcode里的显示效果就很差，而且不能直接显示中文。体验很差！</p>
<p>这时候需要神器<a href="https://www.charlesproxy.com/" target="_blank" rel="external">Charles</a></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1972331-39e2e19c7040a3b9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>上面是Charles的截图，能够监听Mac的所有网络请求并且显示各种格式的内容，非常好用。如果用模拟器的话就可以直接用Charles抓包，如果真机调试的话，需要设置一下iPhone，网上也有很多教程。<br>虽然是付费软件，但是不买license只是打开时会有10秒延时，每隔30分钟自动关闭。</p>
<p>##常见错误<br>Error Domain=com.alamofire.error.serialization.response Code=-1016 “Request failed: unacceptable content-type: text/html” </p>
<p>出现这个问题的原因有很多，从表面上看是返回数据的格式不支持text/html，但是为什么返回了text/html？原因不唯一。<br>首先要看请求的response code，如果是200，说明请求已经传到服务器并且成功返回，返回的格式是text/html。AFNetworking的默认response serializer是AFJSONResponseSerializer，不支持text/html。<br>这时需要在manager的初始化方法中增加一下代码。或者与服务器开发人员沟通，改写服务器端。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">manager.responseSerializer.acceptableContentTypes = [manager.responseSerializer.acceptableContentTypes setByAddingObject:@&quot;text/html&quot;];</div></pre></td></tr></table></figure></p>
<p>如果response code是400，说明服务器根本没有收到请求。这时为什么返回了一个text/html的数据呢？返回的数据在Xcode控制台上显示为16进制，但是在Charles里我们可以看到结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</div><div class="line">&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</div><div class="line">  &lt;head&gt;</div><div class="line">    &lt;title&gt;请求错误&lt;/title&gt;</div><div class="line">    &lt;style&gt;BODY &#123; color: #000000; background-color: white; font-family: Verdana; margin-left: 0px; margin-top: 0px; &#125; #content &#123; margin-left: 30px; font-size: .70em; padding-bottom: 2em; &#125; A:link &#123; color: #336699; font-weight: bold; text-decoration: underline; &#125; A:visited &#123; color: #6699cc; font-weight: bold; text-decoration: underline; &#125; A:active &#123; color: #336699; font-weight: bold; text-decoration: underline; &#125; .heading1 &#123; background-color: #003366; border-bottom: #336699 6px solid; color: #ffffff; font-family: Tahoma; font-size: 26px; font-weight: normal;margin: 0em 0em 10px -20px; padding-bottom: 8px; padding-left: 30px;padding-top: 16px;&#125; pre &#123; font-size:small; background-color: #e5e5cc; padding: 5px; font-family: Courier New; margin-top: 0px; border: 1px #f0f0e0 solid; white-space: pre-wrap; white-space: -pre-wrap; word-wrap: break-word; &#125; table &#123; border-collapse: collapse; border-spacing: 0px; font-family: Verdana;&#125; table th &#123; border-right: 2px white solid; border-bottom: 2px white solid; font-weight: bold; background-color: #cecf9c;&#125; table td &#123; border-right: 2px white solid; border-bottom: 2px white solid; background-color: #e5e5cc;&#125;&lt;/style&gt;</div><div class="line">  &lt;/head&gt;</div><div class="line">  &lt;body&gt;</div><div class="line">    &lt;div id=&quot;content&quot;&gt;</div><div class="line">      &lt;p class=&quot;heading1&quot;&gt;请求错误&lt;/p&gt;</div><div class="line">      &lt;p xmlns=&quot;&quot;&gt;服务器处理请求时遇到错误。有关构造有效服务请求的内容，请参阅&lt;a rel=&quot;help-page&quot; href=&quot;http://www.zjubiomedit.com:13264/HypertensionService.svc/help&quot;&gt;服务帮助页&lt;/a&gt;。&lt;/p&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">  &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>这是自动返回的一个错误页面，而不是服务器返回的数据格式不对。这时候再去找response serializer的问题就南辕北辙了。</p>
<p>那么为什么服务器没有受到请求？<br>一种可能是baseURL的问题。AFHTTPSessionManager的初始化中用到了baseURL，与之后的path拼接时可能出错，检查一下。<br>还有可能是request serializer的问题。AFNetworking默认的是AFHTTPRequestSerializer。如果服务器接受的参数只能是json的话，需要使用AFJSONRequestSerializer。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">self.requestSerializer = [AFJSONRequestSerializer serializer];</div></pre></td></tr></table></figure></p>
<p>可能还有其他各种各样奇怪的原因，欢迎大家补充。</p>
<p>作者时间、能力有限，文章难免有不足之处，请大家指正。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/28/AFNetworking 3.x 使用心得/" data-id="cj21xxnn4000389i3de5gpre6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/03/28/CoreBluetooth连接蓝牙健康设备/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          CoreBluetooth连接蓝牙健康设备
        
      </div>
    </a>
  
  
    <a href="/2017/03/28/Android蓝牙健康设备开发：Health Device Profile(HDP)/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Android蓝牙健康设备开发：Health Device Profile(HDP)</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS开发/">iOS开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/04/28/python文本相似度计算/">(no title)</a>
          </li>
        
          <li>
            <a href="/2017/03/28/CoreBluetooth连接蓝牙健康设备/">CoreBluetooth连接蓝牙健康设备</a>
          </li>
        
          <li>
            <a href="/2017/03/28/AFNetworking 3.x 使用心得/">WordNet</a>
          </li>
        
          <li>
            <a href="/2017/03/28/Android蓝牙健康设备开发：Health Device Profile(HDP)/">Android蓝牙健康设备开发：Health Device Profile(HDP)</a>
          </li>
        
          <li>
            <a href="/2017/03/27/seamcarving/">SeamCarving</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Yiyuan Liu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>